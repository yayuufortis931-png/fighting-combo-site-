<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Admin - コンボ管理</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; }
#char-select { margin-bottom: 20px; }
#combo-area { margin-top: 20px; }
.combo-row { margin-bottom: 25px; padding: 10px; border: 2px solid #666; border-radius: 8px; background: #f0f0f0; position: relative; cursor: grab; }
.row-header { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 8px; }
.row-title { font-weight: bold; font-size: 16px; padding: 5px; flex: 1; }
.row-delete-btn, .row-duplicate-btn { border: none; border-radius: 5px; padding: 4px 8px; cursor: pointer; flex-shrink: 0; }
.row-delete-btn { background:red; color:white; }
.row-duplicate-btn { background:orange; color:white; }
.controls { margin: 10px 0; }
.image-container { display: flex; gap: 10px; flex-wrap: wrap; position: relative; }
.image-box { position: relative; width: 120px; height: 120px; border: 2px solid #ccc; border-radius: 8px; overflow: hidden; background: #f9f9f9; cursor: grab; }
.image-box img { width: 120px; height: 120px; object-fit: contain; }
.delete-btn { position: absolute; top:5px; right:5px; width:25px; height:25px; border-radius:50%; border:none; background:gray; color:white; cursor:pointer; }
.drag-guide { width:4px; background:#007bff; position:absolute; top:0; height:100%; z-index:1000; display:none; }
.row-drag-guide { height:4px; background:#ff6600; width:100%; position:absolute; left:0; z-index:1000; display:none; }
</style>
</head>
<body>
<h2>Admin - コンボ管理</h2>

<label for="char-select">キャラ選択:</label>
<select id="char-select"></select>
<button id="add-row-btn">＋ 段を追加</button>
<button id="save-firestore-btn">💾 Firestore保存</button>

<div id="combo-area"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

// Firebase初期化
const firebaseConfig = {
  apiKey: "AIzaSyAD4fyc-1VlEEGGO631hhpZqCOqllrQ3og",
  authDomain: "st6-combo-maker.firebaseapp.com",
  projectId: "st6-combo-maker",
  storageBucket: "st6-combo-maker.firebasestorage.app",
  messagingSenderId: "945906359459",
  appId: "1:945906359459:web:59a955b609426cf2893316",
  measurementId: "G-YVFY7H6N9E"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ====== DOM & データ ======
const charSelect = document.getElementById("char-select");
const comboArea = document.getElementById("combo-area");
const addRowBtn = document.getElementById("add-row-btn");
const saveFirestoreBtn = document.getElementById("save-firestore-btn");

let characters = ["ルーク","ジェイミー","マノン","キンバリー","マリーザ","リリー","JP","ジュリ","DJ","キャミィ","リュウ","本田","ブランカ","ガイル","ケン","春麗","ザンギエフ","ダルシム","ラシード","AKI","エド","豪鬼","ベガ","テリー","舞","エレナ","サガット","ヴァイパー","アレックス","イングリッド"];
let moveListMap = {};
let rowCount = 0;
let currentChar = characters[0];
let imageMap = {};

// キャラ名→英語フォルダ
const charFolderMap = {
  "ルーク": "luke","ジェイミー": "jamie","マノン": "manon","キンバリー": "kimberly","マリーザ": "marisa","リリー": "lily","JP": "jp",
  "ジュリ": "juri","DJ": "dj","キャミィ": "cammy","リュウ": "ryu","本田": "honda","ブランカ": "blanka","ガイル": "guile","ケン": "ken","春麗": "chunli",
  "ザンギエフ": "zangief","ダルシム": "dhalsim","ラシード": "rashid","AKI": "aki","エド": "ed","豪鬼": "gouki","ベガ": "vega","テリー": "terry",
  "舞": "mai","エレナ": "elena","サガット": "sagat","ヴァイパー": "viper","アレックス": "alex","イングリッド": "ingrid"
};

// ====== 技リスト（省略、一部例のみ） ======
   moveListMap["サガット"] = ["5弱P","2弱P","5弱K","6弱K","2弱K",
  "5中P","6中P","2中P","5中K","2中K",
  "5強P","4強P","2強P","5強K","5強K(1段目)","6強K","2強K",
  "2中P2強P","2中P2強K","5中K5強K","5中P5強K",
  "弱タイガーショット","中タイガーショット","強タイガーショット","ODタイガーショット",
  "弱タイガーアパカ","中タイガーアパカ","強タイガーアパカ","溜めアパカ","ODタイガーアパカ",
  "弱タイガーニー","中タイガーニー","強タイガーニー","ODタイガーニー",
  "弱タイガーネクサス","中タイガーネクサス","強タイガーネクサス","ODタイガーネクサス",
  "弱派生","中派生","強派生",
  "SA1","SA2","SA3",
  "ドライブラッシュ","ドライブインパクト","投げ","ジャンプ","前ステップ",
  "J弱P","J中P","J強P","J弱K","J中K","J強K"];
moveListMap["リュウ"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];
moveListMap["AKI"] = ["5弱P","2弱P","5弱K","2弱K",
      "5中P","3中P","2中P","5中K","2中K",
      "5強P","6強P","2強P","5強K","6強K","2強K",
      "5弱P5弱P","5強P5強P",
      "弱紫煙砲","中紫煙泉","強紫煙撒","OD紫煙砲","OD紫煙追",
      "弱凶襲突","中凶襲突","強凶襲突","OD凶襲突",
      "弱蛇頭鞭","中蛇頭鞭","強蛇頭鞭","OD蛇頭鞭",
      "弱蛇軽功","中蛇軽功","強蛇軽功","OD蛇軽功",
      "猛毒牙","蛇連咬","雁字搦",
      "SA1","SA2","SA3",
      "ドライブラッシュ","ドライブインパクト","投げ","ジャンプ","前ステップ",
      "J弱P","J中P","J強P","J弱K","J中K","J強K"];
moveListMap["ルーク"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];
moveListMap["ジェイミー"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];
moveListMap["マノン"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];
moveListMap["キンバリー"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];
moveListMap["マリーザ"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];
moveListMap["JP"] = ["5弱P","2弱P","5弱K","2弱K",
  "5中P","4中P","2中P","5中K","6中K","2中K",
  "5強P","2強P","3強P","5強K","6強K","2強K",
  "4中P5中P","5強P5強P","5強K5強K5強P","5強P5強P5強K",
  "弱トリグラフ","中トリグラフ","強トリグラフ","弱中トリグラフ","弱強トリグラフ","中強トリグラフ",
  "弱ストリボーグ","中ストリボーグ","強ストリボーグ","ODストリボーグ",
  "弱ヴィーハト","中ヴィーハト","強ヴィーハト","弱中ヴィーハト","弱強ヴィーハト","中強ヴィーハト",
  "弱ヴィーハトアクノ","中ヴィーハトアクノ","ヴィーハトチェーニ",
  "アムネジア","ODアムネジア",
  "弱トルバラン","中トルバラン","強トルバラン","ODトルバラン",
  "アブニマーチ","ODアブニマーチ",
  "SA1","SA2","SA3",
  "ドライブラッシュ","ドライブインパクト","投げ","微歩き","前ステップ",
  "J弱P","J中P","J強P","J弱K","J中K","J強K"];
moveListMap["キャミィ"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];
moveListMap["本田"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];
moveListMap["ブランカ"] = ["5弱P","2弱P","5弱K","2弱K",
      "5中P","6中P","2中P","5中K","4中K","6中K","2中K",
      "5強P","6強P","2強P","3強P","5強K","2強K","3強P",
      "エレクトリックサンダー","ODエレクトリックサンダー",
      "弱バックステップローリング","中バックステップローリング","強バックステップローリング","ODバックステップローリング",
      "弱ローリングアタック","中ローリングアタック","強ローリングアタック","ODローリングアタック",
      "弱エリアルローリング","中エリアルローリング","強エリアルローリング","ODエリアルローリング",
      "弱バーチカルローリング","中バーチカルローリング","強バーチカルローリング","ODバーチカルローリング",
      "フィアーダウン","ワイルドリフト","レイドジャンプ","ワイルドハント","ODワイルドハント",
      "1P","2P","3P","4P","6P","7P","8P","9P",
      "ブランカちゃん爆弾","ブランカちゃんHIT","サプライズフォワード","サプライズバック",
      "SA1","SA2","SA3",
      "ドライブラッシュ","ドライブインパクト","投げ","ディレイ","前ステップ",
      "J弱P","J中P","J強P","J弱K","J中K","J強K","垂直J強P",
      "J弱P","J中P","J強P","J弱K","J中K","J強K","垂直J強P"];
moveListMap["ガイル"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];
moveListMap["ケン"] = ["5弱P","2弱P","5弱K","2弱K",
      "5中P","6中P","2中P","5中K","2中K",
      "5強P","4強P","3強P","2強P","5強K","6強K","2強K","3強K",
      "弱気功拳","中気功拳","強気功拳","OD気功拳",
      "弱百裂脚","中百裂脚","強百裂脚","OD百裂脚",
      "弱スピニングバードキック","中スピニングバードキック","強スピニングバードキック","ODスピニングバードキック",
      "弱覇山蹴","中覇山蹴","強覇山蹴","OD覇山蹴",
      "弱天昇脚","中天昇脚","強天昇脚","OD天昇脚",
      "構え弱P","構え中P","構え強P","構え弱K","構え中K","構え強K",
      "SA1","SA2","SA3",
      "ドライブラッシュ","ドライブインパクト","投げ","ジャンプ","前ステップ",
      "J弱P","J中P","J強P","J強P(2段目)","J弱K","J中K","J2中K","J強K","垂直J強K"];
moveListMap["春麗"] = ["5弱P","2弱P","5弱K","2弱K",
      "5中P","6中P","2中P","5中K","2中K",
      "5強P","4強P","3強P","2強P","5強K","6強K","2強K","3強K",
      "弱気功拳","中気功拳","強気功拳","OD気功拳",
      "弱百裂脚","中百裂脚","強百裂脚","OD百裂脚",
      "弱スピニングバードキック","中スピニングバードキック","強スピニングバードキック","ODスピニングバードキック",
      "弱覇山蹴","中覇山蹴","強覇山蹴","OD覇山蹴",
      "弱天昇脚","中天昇脚","強天昇脚","OD天昇脚",
      "構え弱P","構え中P","構え強P","構え弱K","構え中K","構え強K",
      "SA1","SA2","SA3",
      "ドライブラッシュ","ドライブインパクト","投げ","ジャンプ","前ステップ",
      "J弱P","J中P","J強P","J強P(2段目)","J弱K","J中K","J2中K","J強K","垂直J強K"];
moveListMap["ザンギエフ"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];
moveListMap["ダルシム"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];
moveListMap["ラシード"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];
moveListMap["エド"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];
moveListMap["豪鬼"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];
moveListMap["ベガ"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];
moveListMap["テリー"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];
moveListMap["舞"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];
moveListMap["エレナ"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];
moveListMap["ヴァイパー"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];
moveListMap["アレックス"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];
moveListMap["イングリッド"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];


// キャラ選択肢追加
characters.forEach(c=>{
  const o=document.createElement("option");
  o.value=c; o.textContent=c;
  charSelect.appendChild(o);
});

// ====== Firestoreリアルタイム反映 ======
let unsubscribe = null;
function startRealtimeListener(char){
  if(unsubscribe) unsubscribe();
  const docRef = doc(db,"combos",char);
  unsubscribe = onSnapshot(docRef, (docSnap)=>{
    if(docSnap.exists()){
      const data = docSnap.data().rows || [];
      comboArea.innerHTML=""; rowCount=0;
      data.forEach(r=>addRow(r));
    } else {
      comboArea.innerHTML=""; rowCount=0;
    }
  });
}

// ====== イメージマップ更新 ======
function updateImageMap(){
  imageMap = {};
  (moveListMap[currentChar] || []).forEach(move=>{
    const folder = charFolderMap[currentChar];
    imageMap[move] = `images/${folder}/${move}.png`;
  });
}

// ====== キャラ切替 ======
charSelect.addEventListener("change",()=>{
  currentChar = charSelect.value;
  updateImageMap();
  startRealtimeListener(currentChar);
});

// ====== 段追加 ======
addRowBtn.addEventListener("click",()=>addRow());

// Firestore保存
saveFirestoreBtn.addEventListener("click", async()=>{
  const data = getCurrentData();
  await setDoc(doc(db,"combos",currentChar), {rows:data});
  alert("Firestoreに保存しました");
});

// データ取得
function getCurrentData(){
  return [...comboArea.querySelectorAll(".combo-row")].map(row=>{
    return {title: row.querySelector(".row-title").value,
            moves: [...row.querySelectorAll(".image-box img")].map(img=>img.alt)};
  });
}

// ====== 段追加関数 ======
function addRow(savedData=null){
  rowCount++;
  const rowDiv=document.createElement("div"); rowDiv.classList.add("combo-row"); rowDiv.draggable=true;

  const header=document.createElement("div"); header.classList.add("row-header");
  const titleInput=document.createElement("input"); titleInput.type="text"; titleInput.value=savedData?.title||`コンボ${rowCount}`; titleInput.classList.add("row-title");
  const deleteBtn=document.createElement("button"); deleteBtn.textContent="×段削除"; deleteBtn.classList.add("row-delete-btn"); deleteBtn.addEventListener("click",()=>rowDiv.remove());
  const duplicateBtn=document.createElement("button"); duplicateBtn.textContent="複製"; duplicateBtn.classList.add("row-duplicate-btn"); 
  duplicateBtn.addEventListener("click",()=>duplicateRow(rowDiv));
  header.append(titleInput,deleteBtn,duplicateBtn);

  const controls=document.createElement("div"); controls.classList.add("controls");
  const select=document.createElement("select");
  const defaultOption=document.createElement("option"); defaultOption.value=""; defaultOption.textContent="技を選択してください"; select.appendChild(defaultOption);
  (moveListMap[currentChar] || []).forEach(move=>{ const o=document.createElement("option"); o.value=move; o.textContent=move; select.appendChild(o); });
  const addBtn=document.createElement("button"); addBtn.textContent="追加"; controls.append(select,addBtn);

  const container=document.createElement("div"); container.classList.add("image-container");
  addBtn.addEventListener("click",()=>{ const move=select.value; if(move && imageMap[move]) addImageBox(container,move); });
  if(savedData?.moves) savedData.moves.forEach(m=>addImageBox(container,m));

  rowDiv.append(header,controls,container);
  comboArea.appendChild(rowDiv);
  addRowDragAndDrop(rowDiv);
}

// ====== 複製 ======
function duplicateRow(row){
  const title=row.querySelector(".row-title").value+"_コピー";
  const moves=[...row.querySelectorAll(".image-box img")].map(img=>img.alt);
  const newRow=addRow({title,moves});
  row.after(newRow);
}

// 画像ボックス追加
function addImageBox(container,move){
  const box=document.createElement("div"); box.classList.add("image-box"); box.draggable=true;
  const img=document.createElement("img"); img.src=imageMap[move]; img.alt=move;
  const delBtn=document.createElement("button"); delBtn.textContent="×"; delBtn.classList.add("delete-btn"); delBtn.addEventListener("click",()=>box.remove());
  box.append(img,delBtn); container.appendChild(box);
  addImageDragAndDrop(box,container);
}

// ====== 画像ドラッグ（ガイドバー方式） ======
function addImageDragAndDrop(element,container){
  let guide;
  element.addEventListener("dragstart",(e)=>{
    e.dataTransfer.setData("text/plain","");
    element.classList.add("dragging");
    guide=document.createElement("div"); guide.classList.add("drag-guide"); container.appendChild(guide);
  });
  element.addEventListener("dragend",()=>{
    element.classList.remove("dragging");
    if(guide){ 
      const after=getDragAfterElement(container,e.clientX);
      if(after) container.insertBefore(element,after);
      else container.appendChild(element);
      guide.remove();
    }
  });
  container.addEventListener("dragover",(e)=>{
    e.preventDefault();
    const after=getDragAfterElement(container,e.clientX);
    if(guide){
      guide.style.display="block";
      guide.style.left= after ? after.offsetLeft+"px" : (container.offsetWidth-4)+"px";
    }
  });
}
function getDragAfterElement(container,x){
  const elements=[...container.querySelectorAll(".image-box:not(.dragging)")];
  return elements.find(el=>x<el.getBoundingClientRect().left+el.getBoundingClientRect().width/2);
}

// ====== 段ドラッグ（改善版） ======
function addRowDragAndDrop(row){
  let guide;
  // 入力中はドラッグ禁止
  row.querySelectorAll("input, textarea").forEach(el=>{
    el.addEventListener("mousedown",()=>{ row.draggable=false; });
    el.addEventListener("mouseup",()=>{ row.draggable=true; });
  });

  let lastY=0;
  row.addEventListener("dragstart",(e)=>{
    e.dataTransfer.setData("text/plain","");
    row.classList.add("row-dragging");
    guide=document.createElement("div"); guide.classList.add("row-drag-guide"); comboArea.appendChild(guide);
  });
  row.addEventListener("dragend",()=>{
    row.classList.remove("row-dragging");
    if(guide){ 
      const after=getDragAfterRow(comboArea,lastY);
      if(after) comboArea.insertBefore(row,after);
      else comboArea.appendChild(row);
      guide.remove();
    }
  });
  comboArea.addEventListener("dragover",(e)=>{
    e.preventDefault();
    lastY=e.clientY;
    const after=getDragAfterRow(comboArea,lastY);
    if(guide){
      guide.style.display="block";
      guide.style.top= after ? after.getBoundingClientRect().top+"px" : comboArea.getBoundingClientRect().bottom+"px";
    }
  });
}
function getDragAfterRow(container,y){
  const rows=[...container.querySelectorAll(".combo-row:not(.row-dragging)")];
  return rows.find(r=>y<r.getBoundingClientRect().top+r.getBoundingClientRect().height/2);
}

// 初期ロード
updateImageMap();
startRealtimeListener(currentChar);
</script>
</body>
</html>
