<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Admin - コンボ管理</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; }
#char-select { margin-bottom: 20px; }
#combo-area { margin-top: 20px; }
.combo-row { margin-bottom: 25px; padding: 10px; border: 2px solid #666; border-radius: 8px; background: #f0f0f0; position: relative; cursor: grab; }
.row-header { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 8px; }
.row-title { font-weight: bold; font-size: 16px; padding: 5px; flex: 1; }
.row-delete-btn, .row-duplicate-btn { background: red; color: white; border: none; border-radius: 5px; padding: 4px 8px; cursor: pointer; flex-shrink: 0; }
.row-duplicate-btn { background: orange; }
.controls { margin: 10px 0; }
.image-container { display: flex; gap: 10px; flex-wrap: wrap; position: relative; }
.image-box { position: relative; width: 120px; height: 120px; border: 2px solid #ccc; border-radius: 8px; overflow: hidden; background: #f9f9f9; cursor: grab; }
.image-box img { width: 120px; height: 120px; object-fit: contain; }
.delete-btn { position: absolute; top: 5px; right: 5px; background: gray; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; }
.drag-guide { width: 4px; background: #007bff; position: absolute; top:0; height:100%; z-index:1000; display:none; }
.row-drag-guide { height: 4px; background: #ff6600; width: 100%; position: absolute; left:0; z-index:1000; display:none; }
</style>
</head>
<body>
<h2>Admin - コンボ管理</h2>

<label for="char-select">キャラ選択:</label>
<select id="char-select"></select>

<button id="add-row-btn">＋ 段を追加</button>
<button id="save-local-btn">💾 ローカル保存</button>
<button id="save-firestore-btn">💾 Firestore保存</button>

<div id="combo-area"></div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAD4fyc-1VlEEGGO631hhpZqCOqllrQ3og",
  authDomain: "st6-combo-maker.firebaseapp.com",
  projectId: "st6-combo-maker",
  storageBucket: "st6-combo-maker.firebasestorage.app",
  messagingSenderId: "945906359459",
  appId: "1:945906359459:web:59a955b609426cf2893316",
  measurementId: "G-YVFY7H6N9E"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ====== 共通変数 ======
const charSelect = document.getElementById("char-select");
const comboArea = document.getElementById("combo-area");
const addRowBtn = document.getElementById("add-row-btn");
const saveLocalBtn = document.getElementById("save-local-btn");
const saveFirestoreBtn = document.getElementById("save-firestore-btn");

let characters = ["ルーク","ジェイミー","マノン","キンバリー","マリーザ","リリー","JP","ジュリ","DJ","キャミィ","リュウ","本田","ブランカ","ガイル","ケン","春麗","ザンギエフ","ダルシム","ラシード","AKI","エド","豪鬼","ベガ","テリー","舞","エレナ","サガット","ヴァイパー","アレックス","イングリッド"];
let moveListMap = {}; 
let currentChar = characters[0];
let rowCount = 0;

// ====== 技リスト ======
characters.forEach(c=>{
    moveListMap[c] = ["5弱P","2弱P","5弱K","6弱K","2弱K","5中P","5強P","SA1","SA2","SA3"];
});
moveListMap["サガット"] = ["5弱P","2弱P","5弱K","6弱K","2弱K",
  "5中P","6中P","2中P","5中K","2中K",
  "5強P","4強P","2強P","5強K","5強K(1段目)","6強K","2強K",
  "2中P2強P","2中P2強K","5中K5強K","5中P5強K",
  "弱タイガーショット","中タイガーショット","強タイガーショット","ODタイガーショット",
  "弱タイガーアパカ","中タイガーアパカ","強タイガーアパカ","溜めアパカ","ODタイガーアパカ",
  "弱タイガーニー","中タイガーニー","強タイガーニー","ODタイガーニー",
  "弱タイガーネクサス","中タイガーネクサス","強タイガーネクサス","ODタイガーネクサス",
  "弱派生","中派生","強派生",
  "SA1","SA2","SA3",
  "ドライブラッシュ","ドライブインパクト","投げ","ジャンプ","前ステップ",
  "J弱P","J中P","J強P","J弱K","J中K","J強K"];

// ====== キャラ選択肢追加 ======
characters.forEach(c=>{
    const o = document.createElement("option");
    o.value = c;
    o.textContent = c;
    charSelect.appendChild(o);
});

// ====== キャラ切り替え ======
charSelect.addEventListener("change",()=>{
    currentChar = charSelect.value;
    loadFromFirestore();
});

// ====== 段追加 ======
addRowBtn.addEventListener("click",()=>addRow());

function addRow(savedData=null){
    rowCount++;
    const rowDiv = document.createElement("div");
    rowDiv.classList.add("combo-row");
    rowDiv.draggable = true;

    // ====== ヘッダー ======
    const header = document.createElement("div");
    header.classList.add("row-header");

    const titleInput = document.createElement("input");
    titleInput.type="text";
    titleInput.value = savedData?.title || `コンボ${rowCount}`;
    titleInput.classList.add("row-title");

    const deleteBtn = document.createElement("button");
    deleteBtn.textContent="×段削除";
    deleteBtn.classList.add("row-delete-btn");
    deleteBtn.addEventListener("click",()=>rowDiv.remove());

    const duplicateBtn = document.createElement("button");
    duplicateBtn.textContent="複製";
    duplicateBtn.classList.add("row-duplicate-btn");
    duplicateBtn.addEventListener("click",()=>duplicateRow(rowDiv));

    header.appendChild(titleInput);
    header.appendChild(deleteBtn);
    header.appendChild(duplicateBtn);

    // ====== 技追加 ======
    const controls = document.createElement("div");
    controls.classList.add("controls");
    const select = document.createElement("select");
    const defaultOption = document.createElement("option");
    defaultOption.value="";
    defaultOption.textContent="技を選択してください";
    select.appendChild(defaultOption);
    moveListMap[currentChar].forEach(move=>{
        const o = document.createElement("option");
        o.value = move;
        o.textContent = move;
        select.appendChild(o);
    });
    const addBtn = document.createElement("button");
    addBtn.textContent="追加";
    controls.appendChild(select);
    controls.appendChild(addBtn);

    const container = document.createElement("div");
    container.classList.add("image-container");

    addBtn.addEventListener("click",()=>{ const move = select.value; if(move) addImageBox(container,move); });
    if(savedData?.moves) savedData.moves.forEach(m=>addImageBox(container,m));

    rowDiv.appendChild(header);
    rowDiv.appendChild(controls);
    rowDiv.appendChild(container);
    comboArea.appendChild(rowDiv);

    addRowDragAndDrop(rowDiv);
}

// ====== 複製 ======
function duplicateRow(row){
    const title = row.querySelector(".row-title").value+"_コピー";
    const moves = [...row.querySelectorAll(".image-box img")].map(img=>img.alt);
    addRow({title,moves});
}

// ====== 画像ボックス追加 ======
function addImageBox(container,move){
    const box = document.createElement("div");
    box.classList.add("image-box");
    box.draggable = true;

    const img = document.createElement("img");
    img.src = `images/${currentChar}/${move}.png`;
    img.alt = move;

    const delBtn = document.createElement("button");
    delBtn.textContent="×";
    delBtn.classList.add("delete-btn");
    delBtn.addEventListener("click",()=>box.remove());

    box.appendChild(img);
    box.appendChild(delBtn);
    container.appendChild(box);

    addImageDragAndDrop(box,container);
}

// ====== 画像ドラッグ機能 ======
function addImageDragAndDrop(element,container){
    element.addEventListener("dragstart",(e)=>{
        e.dataTransfer.setData("text/plain","");
        element.classList.add("dragging");
        const guide = document.createElement("div");
        guide.classList.add("drag-guide");
        container.appendChild(guide);
        container.dragGuide = guide;
    });

    element.addEventListener("dragend",()=>{
        element.classList.remove("dragging");
        if(container.dragGuide) container.dragGuide.style.display="none";
    });

    container.addEventListener("dragover",(e)=>{
        e.preventDefault();
        const dragging = container.querySelector(".dragging");
        const after = getDragAfterElement(container,e.clientX);
        const guide = container.dragGuide;
        if(after==null){ container.appendChild(dragging); if(guide) guide.style.display="none"; }
        else{ container.insertBefore(dragging,after); if(guide){ guide.style.display="block"; guide.style.left=after.offsetLeft+"px"; guide.style.height=container.offsetHeight+"px"; } }
    });
}

function getDragAfterElement(container,x){
    const elements = [...container.querySelectorAll(".image-box:not(.dragging)")];
    return elements.find(el=>{ const rect = el.getBoundingClientRect(); return x < rect.left + rect.width/2; });
}

// ====== 段ドラッグ機能 ======
function addRowDragAndDrop(row){
    row.addEventListener("dragstart",(e)=>{
        e.dataTransfer.setData("text/plain","");
        row.classList.add("row-dragging");
        const guide = document.createElement("div");
        guide.classList.add("row-drag-guide");
        comboArea.appendChild(guide);
        comboArea.rowDragGuide = guide;
    });
    row.addEventListener("dragend",()=>{
        row.classList.remove("row-dragging");
        if(comboArea.rowDragGuide) comboArea.rowDragGuide.style.display="none";
    });
    comboArea.addEventListener("dragover",(e)=>{
        e.preventDefault();
        const dragging = comboArea.querySelector(".row-dragging");
        const after = getDragAfterRow(comboArea,e.clientY);
        const guide = comboArea.rowDragGuide;
        if(dragging && after){ comboArea.insertBefore(dragging,after); if(guide){ guide.style.display="block"; guide.style.top=after.offsetTop+"px"; } }
        else if(dragging){ comboArea.appendChild(dragging); if(guide) guide.style.display="none"; }
    });
}

function getDragAfterRow(container,y){
    const rows = [...container.querySelectorAll(".combo-row:not(.row-dragging)")];
    return rows.find(row=>{ const rect = row.getBoundingClientRect(); return y < rect.top + rect.height/2; });
}

// ====== 保存 / 読み込み ======
saveLocalBtn.addEventListener("click",()=>{ localStorage.setItem(currentChar,JSON.stringify(getCurrentData())); alert("保存しました"); });
saveFirestoreBtn.addEventListener("click",async()=>{
    await setDoc(doc(db,"combos",currentChar),getCurrentData());
    alert("Firestore保存しました");
});

function getCurrentData(){
    const data = [];
    comboArea.querySelectorAll(".combo-row").forEach(row=>{
        const title = row.querySelector(".row-title").value;
        const moves = [...row.querySelectorAll(".image-box img")].map(img=>img.alt);
        data.push({title,moves});
    });
    return data;
}

async function loadFromFirestore(){
    comboArea.innerHTML="";
    const docSnap = await getDoc(doc(db,"combos",currentChar));
    const savedData = docSnap.exists()?docSnap.data():[];
    if(savedData.length>0) savedData.forEach(row=>addRow(row));
}

loadFromFirestore();

</script>
</body>
</html>
