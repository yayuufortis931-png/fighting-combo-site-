<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Admin - ã‚³ãƒ³ãƒœç®¡ç†</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; }
#char-select { margin-bottom: 20px; }
#combo-area { margin-top: 20px; }
.combo-row { margin-bottom: 25px; padding: 10px; border: 2px solid #666; border-radius: 8px; background: #f0f0f0; position: relative; cursor: grab; }
.row-header { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 8px; }
.row-title { font-weight: bold; font-size: 16px; padding: 5px; flex: 1; }
.row-delete-btn, .row-duplicate-btn { border: none; border-radius: 5px; padding: 4px 8px; cursor: pointer; flex-shrink: 0; }
.row-delete-btn { background:red; color:white; }
.row-duplicate-btn { background:orange; color:white; }
.controls { margin: 10px 0; }
.image-container { display: flex; gap: 10px; flex-wrap: wrap; position: relative; }
.image-box { position: relative; width: 120px; height: 120px; border: 2px solid #ccc; border-radius: 8px; overflow: hidden; background: #f9f9f9; cursor: grab; }
.image-box img { width: 120px; height: 120px; object-fit: contain; }
.delete-btn { position: absolute; top:5px; right:5px; width:25px; height:25px; border-radius:50%; border:none; background:gray; color:white; cursor:pointer; }
.drag-guide { width:4px; background:#007bff; position:absolute; top:0; height:100%; z-index:1000; display:none; }
.row-drag-guide { height:4px; background:#ff6600; width:100%; position:absolute; left:0; z-index:1000; display:none; }
</style>
</head>
<body>
<h2>Admin - ã‚³ãƒ³ãƒœç®¡ç†</h2>

<label for="char-select">ã‚­ãƒ£ãƒ©é¸æŠ:</label>
<select id="char-select"></select>
<button id="add-row-btn">ï¼‹ æ®µã‚’è¿½åŠ </button>
<button id="save-firestore-btn">ğŸ’¾ Firestoreä¿å­˜</button>

<div id="combo-area"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

// FirebaseåˆæœŸåŒ–
const firebaseConfig = {
  apiKey: "AIzaSyAD4fyc-1VlEEGGO631hhpZqCOqllrQ3og",
  authDomain: "st6-combo-maker.firebaseapp.com",
  projectId: "st6-combo-maker",
  storageBucket: "st6-combo-maker.firebasestorage.app",
  messagingSenderId: "945906359459",
  appId: "1:945906359459:web:59a955b609426cf2893316",
  measurementId: "G-YVFY7H6N9E"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ====== DOM & ãƒ‡ãƒ¼ã‚¿ ======
const charSelect = document.getElementById("char-select");
const comboArea = document.getElementById("combo-area");
const addRowBtn = document.getElementById("add-row-btn");
const saveFirestoreBtn = document.getElementById("save-firestore-btn");

let characters = ["ãƒ«ãƒ¼ã‚¯","ã‚¸ã‚§ã‚¤ãƒŸãƒ¼","ãƒãƒãƒ³","ã‚­ãƒ³ãƒãƒªãƒ¼","ãƒãƒªãƒ¼ã‚¶","ãƒªãƒªãƒ¼","JP","ã‚¸ãƒ¥ãƒª","DJ","ã‚­ãƒ£ãƒŸã‚£","ãƒªãƒ¥ã‚¦","æœ¬ç”°","ãƒ–ãƒ©ãƒ³ã‚«","ã‚¬ã‚¤ãƒ«","ã‚±ãƒ³","æ˜¥éº—","ã‚¶ãƒ³ã‚®ã‚¨ãƒ•","ãƒ€ãƒ«ã‚·ãƒ ","ãƒ©ã‚·ãƒ¼ãƒ‰","AKI","ã‚¨ãƒ‰","è±ªé¬¼","ãƒ™ã‚¬","ãƒ†ãƒªãƒ¼","èˆ","ã‚¨ãƒ¬ãƒŠ","ã‚µã‚¬ãƒƒãƒˆ","ãƒ´ã‚¡ã‚¤ãƒ‘ãƒ¼","ã‚¢ãƒ¬ãƒƒã‚¯ã‚¹","ã‚¤ãƒ³ã‚°ãƒªãƒƒãƒ‰"];
let moveListMap = {};
let rowCount = 0;
let currentChar = characters[0];
let imageMap = {};

// ã‚­ãƒ£ãƒ©åâ†’è‹±èªãƒ•ã‚©ãƒ«ãƒ€
const charFolderMap = {
  "ãƒ«ãƒ¼ã‚¯": "luke","ã‚¸ã‚§ã‚¤ãƒŸãƒ¼": "jamie","ãƒãƒãƒ³": "manon","ã‚­ãƒ³ãƒãƒªãƒ¼": "kimberly","ãƒãƒªãƒ¼ã‚¶": "marisa","ãƒªãƒªãƒ¼": "lily","JP": "jp",
  "ã‚¸ãƒ¥ãƒª": "juri","DJ": "dj","ã‚­ãƒ£ãƒŸã‚£": "cammy","ãƒªãƒ¥ã‚¦": "ryu","æœ¬ç”°": "honda","ãƒ–ãƒ©ãƒ³ã‚«": "blanka","ã‚¬ã‚¤ãƒ«": "guile","ã‚±ãƒ³": "ken","æ˜¥éº—": "chunli",
  "ã‚¶ãƒ³ã‚®ã‚¨ãƒ•": "zangief","ãƒ€ãƒ«ã‚·ãƒ ": "dhalsim","ãƒ©ã‚·ãƒ¼ãƒ‰": "rashid","AKI": "aki","ã‚¨ãƒ‰": "ed","è±ªé¬¼": "gouki","ãƒ™ã‚¬": "vega","ãƒ†ãƒªãƒ¼": "terry",
  "èˆ": "mai","ã‚¨ãƒ¬ãƒŠ": "elena","ã‚µã‚¬ãƒƒãƒˆ": "sagat","ãƒ´ã‚¡ã‚¤ãƒ‘ãƒ¼": "viper","ã‚¢ãƒ¬ãƒƒã‚¯ã‚¹": "alex","ã‚¤ãƒ³ã‚°ãƒªãƒƒãƒ‰": "ingrid"
};

// ====== æŠ€ãƒªã‚¹ãƒˆï¼ˆçœç•¥ã€ä¸€éƒ¨ä¾‹ã®ã¿ï¼‰ ======
   moveListMap["ã‚µã‚¬ãƒƒãƒˆ"] = ["5å¼±P","2å¼±P","5å¼±K","6å¼±K","2å¼±K",
  "5ä¸­P","6ä¸­P","2ä¸­P","5ä¸­K","2ä¸­K",
  "5å¼·P","4å¼·P","2å¼·P","5å¼·K","5å¼·K(1æ®µç›®)","6å¼·K","2å¼·K",
  "2ä¸­P2å¼·P","2ä¸­P2å¼·K","5ä¸­K5å¼·K","5ä¸­P5å¼·K",
  "å¼±ã‚¿ã‚¤ã‚¬ãƒ¼ã‚·ãƒ§ãƒƒãƒˆ","ä¸­ã‚¿ã‚¤ã‚¬ãƒ¼ã‚·ãƒ§ãƒƒãƒˆ","å¼·ã‚¿ã‚¤ã‚¬ãƒ¼ã‚·ãƒ§ãƒƒãƒˆ","ODã‚¿ã‚¤ã‚¬ãƒ¼ã‚·ãƒ§ãƒƒãƒˆ",
  "å¼±ã‚¿ã‚¤ã‚¬ãƒ¼ã‚¢ãƒ‘ã‚«","ä¸­ã‚¿ã‚¤ã‚¬ãƒ¼ã‚¢ãƒ‘ã‚«","å¼·ã‚¿ã‚¤ã‚¬ãƒ¼ã‚¢ãƒ‘ã‚«","æºœã‚ã‚¢ãƒ‘ã‚«","ODã‚¿ã‚¤ã‚¬ãƒ¼ã‚¢ãƒ‘ã‚«",
  "å¼±ã‚¿ã‚¤ã‚¬ãƒ¼ãƒ‹ãƒ¼","ä¸­ã‚¿ã‚¤ã‚¬ãƒ¼ãƒ‹ãƒ¼","å¼·ã‚¿ã‚¤ã‚¬ãƒ¼ãƒ‹ãƒ¼","ODã‚¿ã‚¤ã‚¬ãƒ¼ãƒ‹ãƒ¼",
  "å¼±ã‚¿ã‚¤ã‚¬ãƒ¼ãƒã‚¯ã‚µã‚¹","ä¸­ã‚¿ã‚¤ã‚¬ãƒ¼ãƒã‚¯ã‚µã‚¹","å¼·ã‚¿ã‚¤ã‚¬ãƒ¼ãƒã‚¯ã‚µã‚¹","ODã‚¿ã‚¤ã‚¬ãƒ¼ãƒã‚¯ã‚µã‚¹",
  "å¼±æ´¾ç”Ÿ","ä¸­æ´¾ç”Ÿ","å¼·æ´¾ç”Ÿ",
  "SA1","SA2","SA3",
  "ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒƒã‚·ãƒ¥","ãƒ‰ãƒ©ã‚¤ãƒ–ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ","æŠ•ã’","ã‚¸ãƒ£ãƒ³ãƒ—","å‰ã‚¹ãƒ†ãƒƒãƒ—",
  "Jå¼±P","Jä¸­P","Jå¼·P","Jå¼±K","Jä¸­K","Jå¼·K"];
moveListMap["ãƒªãƒ¥ã‚¦"] = ["5å¼±P", "2å¼±P", "æ³¢å‹•æ‹³", "æ˜‡é¾æ‹³", "ç«œå·»æ—‹é¢¨è„š"];
moveListMap["AKI"] = ["5å¼±P","2å¼±P","5å¼±K","2å¼±K",
      "5ä¸­P","3ä¸­P","2ä¸­P","5ä¸­K","2ä¸­K",
      "5å¼·P","6å¼·P","2å¼·P","5å¼·K","6å¼·K","2å¼·K",
      "5å¼±P5å¼±P","5å¼·P5å¼·P",
      "å¼±ç´«ç…™ç ²","ä¸­ç´«ç…™æ³‰","å¼·ç´«ç…™æ’’","ODç´«ç…™ç ²","ODç´«ç…™è¿½",
      "å¼±å‡¶è¥²çª","ä¸­å‡¶è¥²çª","å¼·å‡¶è¥²çª","ODå‡¶è¥²çª",
      "å¼±è›‡é ­é­","ä¸­è›‡é ­é­","å¼·è›‡é ­é­","ODè›‡é ­é­",
      "å¼±è›‡è»½åŠŸ","ä¸­è›‡è»½åŠŸ","å¼·è›‡è»½åŠŸ","ODè›‡è»½åŠŸ",
      "çŒ›æ¯’ç‰™","è›‡é€£å’¬","é›å­—æ¦",
      "SA1","SA2","SA3",
      "ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒƒã‚·ãƒ¥","ãƒ‰ãƒ©ã‚¤ãƒ–ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ","æŠ•ã’","ã‚¸ãƒ£ãƒ³ãƒ—","å‰ã‚¹ãƒ†ãƒƒãƒ—",
      "Jå¼±P","Jä¸­P","Jå¼·P","Jå¼±K","Jä¸­K","Jå¼·K"];
moveListMap["ãƒ«ãƒ¼ã‚¯"] = ["5å¼±P", "2å¼±P", "æ³¢å‹•æ‹³", "æ˜‡é¾æ‹³", "ç«œå·»æ—‹é¢¨è„š"];
moveListMap["ã‚¸ã‚§ã‚¤ãƒŸãƒ¼"] = ["5å¼±P", "2å¼±P", "æ³¢å‹•æ‹³", "æ˜‡é¾æ‹³", "ç«œå·»æ—‹é¢¨è„š"];
moveListMap["ãƒãƒãƒ³"] = ["5å¼±P", "2å¼±P", "æ³¢å‹•æ‹³", "æ˜‡é¾æ‹³", "ç«œå·»æ—‹é¢¨è„š"];
moveListMap["ã‚­ãƒ³ãƒãƒªãƒ¼"] = ["5å¼±P", "2å¼±P", "æ³¢å‹•æ‹³", "æ˜‡é¾æ‹³", "ç«œå·»æ—‹é¢¨è„š"];
moveListMap["ãƒãƒªãƒ¼ã‚¶"] = ["5å¼±P", "2å¼±P", "æ³¢å‹•æ‹³", "æ˜‡é¾æ‹³", "ç«œå·»æ—‹é¢¨è„š"];
moveListMap["JP"] = ["5å¼±P","2å¼±P","5å¼±K","2å¼±K",
  "5ä¸­P","4ä¸­P","2ä¸­P","5ä¸­K","6ä¸­K","2ä¸­K",
  "5å¼·P","2å¼·P","3å¼·P","5å¼·K","6å¼·K","2å¼·K",
  "4ä¸­P5ä¸­P","5å¼·P5å¼·P","5å¼·K5å¼·K5å¼·P","5å¼·P5å¼·P5å¼·K",
  "å¼±ãƒˆãƒªã‚°ãƒ©ãƒ•","ä¸­ãƒˆãƒªã‚°ãƒ©ãƒ•","å¼·ãƒˆãƒªã‚°ãƒ©ãƒ•","å¼±ä¸­ãƒˆãƒªã‚°ãƒ©ãƒ•","å¼±å¼·ãƒˆãƒªã‚°ãƒ©ãƒ•","ä¸­å¼·ãƒˆãƒªã‚°ãƒ©ãƒ•",
  "å¼±ã‚¹ãƒˆãƒªãƒœãƒ¼ã‚°","ä¸­ã‚¹ãƒˆãƒªãƒœãƒ¼ã‚°","å¼·ã‚¹ãƒˆãƒªãƒœãƒ¼ã‚°","ODã‚¹ãƒˆãƒªãƒœãƒ¼ã‚°",
  "å¼±ãƒ´ã‚£ãƒ¼ãƒãƒˆ","ä¸­ãƒ´ã‚£ãƒ¼ãƒãƒˆ","å¼·ãƒ´ã‚£ãƒ¼ãƒãƒˆ","å¼±ä¸­ãƒ´ã‚£ãƒ¼ãƒãƒˆ","å¼±å¼·ãƒ´ã‚£ãƒ¼ãƒãƒˆ","ä¸­å¼·ãƒ´ã‚£ãƒ¼ãƒãƒˆ",
  "å¼±ãƒ´ã‚£ãƒ¼ãƒãƒˆã‚¢ã‚¯ãƒ","ä¸­ãƒ´ã‚£ãƒ¼ãƒãƒˆã‚¢ã‚¯ãƒ","ãƒ´ã‚£ãƒ¼ãƒãƒˆãƒã‚§ãƒ¼ãƒ‹",
  "ã‚¢ãƒ ãƒã‚¸ã‚¢","ODã‚¢ãƒ ãƒã‚¸ã‚¢",
  "å¼±ãƒˆãƒ«ãƒãƒ©ãƒ³","ä¸­ãƒˆãƒ«ãƒãƒ©ãƒ³","å¼·ãƒˆãƒ«ãƒãƒ©ãƒ³","ODãƒˆãƒ«ãƒãƒ©ãƒ³",
  "ã‚¢ãƒ–ãƒ‹ãƒãƒ¼ãƒ","ODã‚¢ãƒ–ãƒ‹ãƒãƒ¼ãƒ",
  "SA1","SA2","SA3",
  "ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒƒã‚·ãƒ¥","ãƒ‰ãƒ©ã‚¤ãƒ–ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ","æŠ•ã’","å¾®æ­©ã","å‰ã‚¹ãƒ†ãƒƒãƒ—",
  "Jå¼±P","Jä¸­P","Jå¼·P","Jå¼±K","Jä¸­K","Jå¼·K"];
moveListMap["ã‚­ãƒ£ãƒŸã‚£"] = ["5å¼±P", "2å¼±P", "æ³¢å‹•æ‹³", "æ˜‡é¾æ‹³", "ç«œå·»æ—‹é¢¨è„š"];
moveListMap["æœ¬ç”°"] = ["5å¼±P", "2å¼±P", "æ³¢å‹•æ‹³", "æ˜‡é¾æ‹³", "ç«œå·»æ—‹é¢¨è„š"];
moveListMap["ãƒ–ãƒ©ãƒ³ã‚«"] = ["5å¼±P","2å¼±P","5å¼±K","2å¼±K",
      "5ä¸­P","6ä¸­P","2ä¸­P","5ä¸­K","4ä¸­K","6ä¸­K","2ä¸­K",
      "5å¼·P","6å¼·P","2å¼·P","3å¼·P","5å¼·K","2å¼·K","3å¼·P",
      "ã‚¨ãƒ¬ã‚¯ãƒˆãƒªãƒƒã‚¯ã‚µãƒ³ãƒ€ãƒ¼","ODã‚¨ãƒ¬ã‚¯ãƒˆãƒªãƒƒã‚¯ã‚µãƒ³ãƒ€ãƒ¼",
      "å¼±ãƒãƒƒã‚¯ã‚¹ãƒ†ãƒƒãƒ—ãƒ­ãƒ¼ãƒªãƒ³ã‚°","ä¸­ãƒãƒƒã‚¯ã‚¹ãƒ†ãƒƒãƒ—ãƒ­ãƒ¼ãƒªãƒ³ã‚°","å¼·ãƒãƒƒã‚¯ã‚¹ãƒ†ãƒƒãƒ—ãƒ­ãƒ¼ãƒªãƒ³ã‚°","ODãƒãƒƒã‚¯ã‚¹ãƒ†ãƒƒãƒ—ãƒ­ãƒ¼ãƒªãƒ³ã‚°",
      "å¼±ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¢ã‚¿ãƒƒã‚¯","ä¸­ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¢ã‚¿ãƒƒã‚¯","å¼·ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¢ã‚¿ãƒƒã‚¯","ODãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¢ã‚¿ãƒƒã‚¯",
      "å¼±ã‚¨ãƒªã‚¢ãƒ«ãƒ­ãƒ¼ãƒªãƒ³ã‚°","ä¸­ã‚¨ãƒªã‚¢ãƒ«ãƒ­ãƒ¼ãƒªãƒ³ã‚°","å¼·ã‚¨ãƒªã‚¢ãƒ«ãƒ­ãƒ¼ãƒªãƒ³ã‚°","ODã‚¨ãƒªã‚¢ãƒ«ãƒ­ãƒ¼ãƒªãƒ³ã‚°",
      "å¼±ãƒãƒ¼ãƒã‚«ãƒ«ãƒ­ãƒ¼ãƒªãƒ³ã‚°","ä¸­ãƒãƒ¼ãƒã‚«ãƒ«ãƒ­ãƒ¼ãƒªãƒ³ã‚°","å¼·ãƒãƒ¼ãƒã‚«ãƒ«ãƒ­ãƒ¼ãƒªãƒ³ã‚°","ODãƒãƒ¼ãƒã‚«ãƒ«ãƒ­ãƒ¼ãƒªãƒ³ã‚°",
      "ãƒ•ã‚£ã‚¢ãƒ¼ãƒ€ã‚¦ãƒ³","ãƒ¯ã‚¤ãƒ«ãƒ‰ãƒªãƒ•ãƒˆ","ãƒ¬ã‚¤ãƒ‰ã‚¸ãƒ£ãƒ³ãƒ—","ãƒ¯ã‚¤ãƒ«ãƒ‰ãƒãƒ³ãƒˆ","ODãƒ¯ã‚¤ãƒ«ãƒ‰ãƒãƒ³ãƒˆ",
      "1P","2P","3P","4P","6P","7P","8P","9P",
      "ãƒ–ãƒ©ãƒ³ã‚«ã¡ã‚ƒã‚“çˆ†å¼¾","ãƒ–ãƒ©ãƒ³ã‚«ã¡ã‚ƒã‚“HIT","ã‚µãƒ—ãƒ©ã‚¤ã‚ºãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰","ã‚µãƒ—ãƒ©ã‚¤ã‚ºãƒãƒƒã‚¯",
      "SA1","SA2","SA3",
      "ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒƒã‚·ãƒ¥","ãƒ‰ãƒ©ã‚¤ãƒ–ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ","æŠ•ã’","ãƒ‡ã‚£ãƒ¬ã‚¤","å‰ã‚¹ãƒ†ãƒƒãƒ—",
      "Jå¼±P","Jä¸­P","Jå¼·P","Jå¼±K","Jä¸­K","Jå¼·K","å‚ç›´Jå¼·P",
      "Jå¼±P","Jä¸­P","Jå¼·P","Jå¼±K","Jä¸­K","Jå¼·K","å‚ç›´Jå¼·P"];
moveListMap["ã‚¬ã‚¤ãƒ«"] = ["5å¼±P", "2å¼±P", "æ³¢å‹•æ‹³", "æ˜‡é¾æ‹³", "ç«œå·»æ—‹é¢¨è„š"];
moveListMap["ã‚±ãƒ³"] = ["5å¼±P","2å¼±P","5å¼±K","2å¼±K",
      "5ä¸­P","6ä¸­P","2ä¸­P","5ä¸­K","2ä¸­K",
      "5å¼·P","4å¼·P","3å¼·P","2å¼·P","5å¼·K","6å¼·K","2å¼·K","3å¼·K",
      "å¼±æ°—åŠŸæ‹³","ä¸­æ°—åŠŸæ‹³","å¼·æ°—åŠŸæ‹³","ODæ°—åŠŸæ‹³",
      "å¼±ç™¾è£‚è„š","ä¸­ç™¾è£‚è„š","å¼·ç™¾è£‚è„š","ODç™¾è£‚è„š",
      "å¼±ã‚¹ãƒ”ãƒ‹ãƒ³ã‚°ãƒãƒ¼ãƒ‰ã‚­ãƒƒã‚¯","ä¸­ã‚¹ãƒ”ãƒ‹ãƒ³ã‚°ãƒãƒ¼ãƒ‰ã‚­ãƒƒã‚¯","å¼·ã‚¹ãƒ”ãƒ‹ãƒ³ã‚°ãƒãƒ¼ãƒ‰ã‚­ãƒƒã‚¯","ODã‚¹ãƒ”ãƒ‹ãƒ³ã‚°ãƒãƒ¼ãƒ‰ã‚­ãƒƒã‚¯",
      "å¼±è¦‡å±±è¹´","ä¸­è¦‡å±±è¹´","å¼·è¦‡å±±è¹´","ODè¦‡å±±è¹´",
      "å¼±å¤©æ˜‡è„š","ä¸­å¤©æ˜‡è„š","å¼·å¤©æ˜‡è„š","ODå¤©æ˜‡è„š",
      "æ§‹ãˆå¼±P","æ§‹ãˆä¸­P","æ§‹ãˆå¼·P","æ§‹ãˆå¼±K","æ§‹ãˆä¸­K","æ§‹ãˆå¼·K",
      "SA1","SA2","SA3",
      "ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒƒã‚·ãƒ¥","ãƒ‰ãƒ©ã‚¤ãƒ–ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ","æŠ•ã’","ã‚¸ãƒ£ãƒ³ãƒ—","å‰ã‚¹ãƒ†ãƒƒãƒ—",
      "Jå¼±P","Jä¸­P","Jå¼·P","Jå¼·P(2æ®µç›®)","Jå¼±K","Jä¸­K","J2ä¸­K","Jå¼·K","å‚ç›´Jå¼·K"];
moveListMap["æ˜¥éº—"] = ["5å¼±P","2å¼±P","5å¼±K","2å¼±K",
      "5ä¸­P","6ä¸­P","2ä¸­P","5ä¸­K","2ä¸­K",
      "5å¼·P","4å¼·P","3å¼·P","2å¼·P","5å¼·K","6å¼·K","2å¼·K","3å¼·K",
      "å¼±æ°—åŠŸæ‹³","ä¸­æ°—åŠŸæ‹³","å¼·æ°—åŠŸæ‹³","ODæ°—åŠŸæ‹³",
      "å¼±ç™¾è£‚è„š","ä¸­ç™¾è£‚è„š","å¼·ç™¾è£‚è„š","ODç™¾è£‚è„š",
      "å¼±ã‚¹ãƒ”ãƒ‹ãƒ³ã‚°ãƒãƒ¼ãƒ‰ã‚­ãƒƒã‚¯","ä¸­ã‚¹ãƒ”ãƒ‹ãƒ³ã‚°ãƒãƒ¼ãƒ‰ã‚­ãƒƒã‚¯","å¼·ã‚¹ãƒ”ãƒ‹ãƒ³ã‚°ãƒãƒ¼ãƒ‰ã‚­ãƒƒã‚¯","ODã‚¹ãƒ”ãƒ‹ãƒ³ã‚°ãƒãƒ¼ãƒ‰ã‚­ãƒƒã‚¯",
      "å¼±è¦‡å±±è¹´","ä¸­è¦‡å±±è¹´","å¼·è¦‡å±±è¹´","ODè¦‡å±±è¹´",
      "å¼±å¤©æ˜‡è„š","ä¸­å¤©æ˜‡è„š","å¼·å¤©æ˜‡è„š","ODå¤©æ˜‡è„š",
      "æ§‹ãˆå¼±P","æ§‹ãˆä¸­P","æ§‹ãˆå¼·P","æ§‹ãˆå¼±K","æ§‹ãˆä¸­K","æ§‹ãˆå¼·K",
      "SA1","SA2","SA3",
      "ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒƒã‚·ãƒ¥","ãƒ‰ãƒ©ã‚¤ãƒ–ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ","æŠ•ã’","ã‚¸ãƒ£ãƒ³ãƒ—","å‰ã‚¹ãƒ†ãƒƒãƒ—",
      "Jå¼±P","Jä¸­P","Jå¼·P","Jå¼·P(2æ®µç›®)","Jå¼±K","Jä¸­K","J2ä¸­K","Jå¼·K","å‚ç›´Jå¼·K"];
moveListMap["ã‚¶ãƒ³ã‚®ã‚¨ãƒ•"] = ["5å¼±P", "2å¼±P", "æ³¢å‹•æ‹³", "æ˜‡é¾æ‹³", "ç«œå·»æ—‹é¢¨è„š"];
moveListMap["ãƒ€ãƒ«ã‚·ãƒ "] = ["5å¼±P", "2å¼±P", "æ³¢å‹•æ‹³", "æ˜‡é¾æ‹³", "ç«œå·»æ—‹é¢¨è„š"];
moveListMap["ãƒ©ã‚·ãƒ¼ãƒ‰"] = ["5å¼±P", "2å¼±P", "æ³¢å‹•æ‹³", "æ˜‡é¾æ‹³", "ç«œå·»æ—‹é¢¨è„š"];
moveListMap["ã‚¨ãƒ‰"] = ["5å¼±P", "2å¼±P", "æ³¢å‹•æ‹³", "æ˜‡é¾æ‹³", "ç«œå·»æ—‹é¢¨è„š"];
moveListMap["è±ªé¬¼"] = ["5å¼±P", "2å¼±P", "æ³¢å‹•æ‹³", "æ˜‡é¾æ‹³", "ç«œå·»æ—‹é¢¨è„š"];
moveListMap["ãƒ™ã‚¬"] = ["5å¼±P", "2å¼±P", "æ³¢å‹•æ‹³", "æ˜‡é¾æ‹³", "ç«œå·»æ—‹é¢¨è„š"];
moveListMap["ãƒ†ãƒªãƒ¼"] = ["5å¼±P", "2å¼±P", "æ³¢å‹•æ‹³", "æ˜‡é¾æ‹³", "ç«œå·»æ—‹é¢¨è„š"];
moveListMap["èˆ"] = ["5å¼±P", "2å¼±P", "æ³¢å‹•æ‹³", "æ˜‡é¾æ‹³", "ç«œå·»æ—‹é¢¨è„š"];
moveListMap["ã‚¨ãƒ¬ãƒŠ"] = ["5å¼±P", "2å¼±P", "æ³¢å‹•æ‹³", "æ˜‡é¾æ‹³", "ç«œå·»æ—‹é¢¨è„š"];
moveListMap["ãƒ´ã‚¡ã‚¤ãƒ‘ãƒ¼"] = ["5å¼±P", "2å¼±P", "æ³¢å‹•æ‹³", "æ˜‡é¾æ‹³", "ç«œå·»æ—‹é¢¨è„š"];
moveListMap["ã‚¢ãƒ¬ãƒƒã‚¯ã‚¹"] = ["5å¼±P", "2å¼±P", "æ³¢å‹•æ‹³", "æ˜‡é¾æ‹³", "ç«œå·»æ—‹é¢¨è„š"];
moveListMap["ã‚¤ãƒ³ã‚°ãƒªãƒƒãƒ‰"] = ["5å¼±P", "2å¼±P", "æ³¢å‹•æ‹³", "æ˜‡é¾æ‹³", "ç«œå·»æ—‹é¢¨è„š"];


// ã‚­ãƒ£ãƒ©é¸æŠè‚¢è¿½åŠ 
characters.forEach(c=>{
  const o=document.createElement("option");
  o.value=c; o.textContent=c;
  charSelect.appendChild(o);
});

// ====== Firestoreãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åæ˜  ======
let unsubscribe = null;
function startRealtimeListener(char){
  if(unsubscribe) unsubscribe();
  const docRef = doc(db,"combos",char);
  unsubscribe = onSnapshot(docRef, (docSnap)=>{
    if(docSnap.exists()){
      const data = docSnap.data().rows || [];
      comboArea.innerHTML=""; rowCount=0;
      data.forEach(r=>addRow(r));
    } else {
      comboArea.innerHTML=""; rowCount=0;
    }
  });
}

// ====== ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒãƒƒãƒ—æ›´æ–° ======
function updateImageMap(){
  imageMap = {};
  (moveListMap[currentChar] || []).forEach(move=>{
    const folder = charFolderMap[currentChar];
    imageMap[move] = `images/${folder}/${move}.png`;
  });
}

// ====== ã‚­ãƒ£ãƒ©åˆ‡æ›¿ ======
charSelect.addEventListener("change",()=>{
  currentChar = charSelect.value;
  updateImageMap();
  startRealtimeListener(currentChar);
});

// ====== æ®µè¿½åŠ  ======
addRowBtn.addEventListener("click",()=>addRow());

// Firestoreä¿å­˜
saveFirestoreBtn.addEventListener("click", async()=>{
  const data = getCurrentData();
  await setDoc(doc(db,"combos",currentChar), {rows:data});
  alert("Firestoreã«ä¿å­˜ã—ã¾ã—ãŸ");
});

// ãƒ‡ãƒ¼ã‚¿å–å¾—
function getCurrentData(){
  return [...comboArea.querySelectorAll(".combo-row")].map(row=>{
    return {title: row.querySelector(".row-title").value,
            moves: [...row.querySelectorAll(".image-box img")].map(img=>img.alt)};
  });
}

// ====== æ®µè¿½åŠ é–¢æ•° ======
function addRow(savedData=null){
  rowCount++;
  const rowDiv=document.createElement("div"); rowDiv.classList.add("combo-row"); rowDiv.draggable=true;

  const header=document.createElement("div"); header.classList.add("row-header");
  const titleInput=document.createElement("input"); titleInput.type="text"; titleInput.value=savedData?.title||`ã‚³ãƒ³ãƒœ${rowCount}`; titleInput.classList.add("row-title");
  const deleteBtn=document.createElement("button"); deleteBtn.textContent="Ã—æ®µå‰Šé™¤"; deleteBtn.classList.add("row-delete-btn"); deleteBtn.addEventListener("click",()=>rowDiv.remove());
  const duplicateBtn=document.createElement("button"); duplicateBtn.textContent="è¤‡è£½"; duplicateBtn.classList.add("row-duplicate-btn"); 
  duplicateBtn.addEventListener("click",()=>duplicateRow(rowDiv));
  header.append(titleInput,deleteBtn,duplicateBtn);

  const controls=document.createElement("div"); controls.classList.add("controls");
  const select=document.createElement("select");
  const defaultOption=document.createElement("option"); defaultOption.value=""; defaultOption.textContent="æŠ€ã‚’é¸æŠã—ã¦ãã ã•ã„"; select.appendChild(defaultOption);
  (moveListMap[currentChar] || []).forEach(move=>{ const o=document.createElement("option"); o.value=move; o.textContent=move; select.appendChild(o); });
  const addBtn=document.createElement("button"); addBtn.textContent="è¿½åŠ "; controls.append(select,addBtn);

  const container=document.createElement("div"); container.classList.add("image-container");
  addBtn.addEventListener("click",()=>{ const move=select.value; if(move && imageMap[move]) addImageBox(container,move); });
  if(savedData?.moves) savedData.moves.forEach(m=>addImageBox(container,m));

  rowDiv.append(header,controls,container);
  comboArea.appendChild(rowDiv);
  addRowDragAndDrop(rowDiv);
}

// ====== è¤‡è£½ ======
function duplicateRow(row){
  const title=row.querySelector(".row-title").value+"_ã‚³ãƒ”ãƒ¼";
  const moves=[...row.querySelectorAll(".image-box img")].map(img=>img.alt);
  const newRow=addRow({title,moves});
  row.after(newRow);
}

// ç”»åƒãƒœãƒƒã‚¯ã‚¹è¿½åŠ 
function addImageBox(container,move){
  const box=document.createElement("div"); box.classList.add("image-box"); box.draggable=true;
  const img=document.createElement("img"); img.src=imageMap[move]; img.alt=move;
  const delBtn=document.createElement("button"); delBtn.textContent="Ã—"; delBtn.classList.add("delete-btn"); delBtn.addEventListener("click",()=>box.remove());
  box.append(img,delBtn); container.appendChild(box);
  addImageDragAndDrop(box,container);
}

// ====== ç”»åƒãƒ‰ãƒ©ãƒƒã‚°ï¼ˆã‚¬ã‚¤ãƒ‰ãƒãƒ¼æ–¹å¼ï¼‰ ======
function addImageDragAndDrop(element,container){
  let guide;
  element.addEventListener("dragstart",(e)=>{
    e.dataTransfer.setData("text/plain","");
    element.classList.add("dragging");
    guide=document.createElement("div"); guide.classList.add("drag-guide"); container.appendChild(guide);
  });
  element.addEventListener("dragend",()=>{
    element.classList.remove("dragging");
    if(guide){ 
      const after=getDragAfterElement(container,e.clientX);
      if(after) container.insertBefore(element,after);
      else container.appendChild(element);
      guide.remove();
    }
  });
  container.addEventListener("dragover",(e)=>{
    e.preventDefault();
    const after=getDragAfterElement(container,e.clientX);
    if(guide){
      guide.style.display="block";
      guide.style.left= after ? after.offsetLeft+"px" : (container.offsetWidth-4)+"px";
    }
  });
}
function getDragAfterElement(container,x){
  const elements=[...container.querySelectorAll(".image-box:not(.dragging)")];
  return elements.find(el=>x<el.getBoundingClientRect().left+el.getBoundingClientRect().width/2);
}

// ====== æ®µãƒ‰ãƒ©ãƒƒã‚°ï¼ˆæ”¹å–„ç‰ˆï¼‰ ======
function addRowDragAndDrop(row){
  let guide;
  // å…¥åŠ›ä¸­ã¯ãƒ‰ãƒ©ãƒƒã‚°ç¦æ­¢
  row.querySelectorAll("input, textarea").forEach(el=>{
    el.addEventListener("mousedown",()=>{ row.draggable=false; });
    el.addEventListener("mouseup",()=>{ row.draggable=true; });
  });

  let lastY=0;
  row.addEventListener("dragstart",(e)=>{
    e.dataTransfer.setData("text/plain","");
    row.classList.add("row-dragging");
    guide=document.createElement("div"); guide.classList.add("row-drag-guide"); comboArea.appendChild(guide);
  });
  row.addEventListener("dragend",()=>{
    row.classList.remove("row-dragging");
    if(guide){ 
      const after=getDragAfterRow(comboArea,lastY);
      if(after) comboArea.insertBefore(row,after);
      else comboArea.appendChild(row);
      guide.remove();
    }
  });
  comboArea.addEventListener("dragover",(e)=>{
    e.preventDefault();
    lastY=e.clientY;
    const after=getDragAfterRow(comboArea,lastY);
    if(guide){
      guide.style.display="block";
      guide.style.top= after ? after.getBoundingClientRect().top+"px" : comboArea.getBoundingClientRect().bottom+"px";
    }
  });
}
function getDragAfterRow(container,y){
  const rows=[...container.querySelectorAll(".combo-row:not(.row-dragging)")];
  return rows.find(r=>y<r.getBoundingClientRect().top+r.getBoundingClientRect().height/2);
}

// åˆæœŸãƒ­ãƒ¼ãƒ‰
updateImageMap();
startRealtimeListener(currentChar);
</script>
</body>
</html>
