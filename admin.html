<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Admin - コンボ管理</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; }
#char-select { margin-bottom: 20px; }
#combo-area { margin-top: 20px; }
.combo-row { margin-bottom: 25px; padding: 10px; border: 2px solid #666; border-radius: 8px; background: #f0f0f0; position: relative; cursor: grab; }
.row-header { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 8px; }
.row-title { font-weight: bold; font-size: 16px; padding: 5px; flex: 1; }
.row-delete-btn, .row-duplicate-btn { border: none; border-radius: 5px; padding: 4px 8px; cursor: pointer; flex-shrink: 0; }
.row-delete-btn { background:red; color:white; }
.row-duplicate-btn { background:orange; color:white; }
.controls { margin: 10px 0; }
.image-container { display: flex; gap: 10px; flex-wrap: wrap; position: relative; }
.image-box { position: relative; width: 120px; height: 120px; border: 2px solid #ccc; border-radius: 8px; overflow: hidden; background: #f9f9f9; cursor: grab; }
.image-box img { width: 120px; height: 120px; object-fit: contain; }
.delete-btn { position: absolute; top:5px; right:5px; width:25px; height:25px; border-radius:50%; border:none; background:gray; color:white; cursor:pointer; }
.drag-guide { width:4px; background:#007bff; position:absolute; top:0; height:100%; z-index:1000; display:none; }
.row-drag-guide { height:4px; background:#ff6600; width:100%; position:absolute; left:0; z-index:1000; display:none; }
</style>
</head>
<body>
<h2>Admin - コンボ管理</h2>

<label for="char-select">キャラ選択:</label>
<select id="char-select"></select>
<button id="add-row-btn">＋ 段を追加</button>
<button id="save-firestore-btn">💾 Firestore保存</button>

<div id="combo-area"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAD4fyc-1VlEEGGO631hhpZqCOqllrQ3og",
  authDomain: "st6-combo-maker.firebaseapp.com",
  projectId: "st6-combo-maker",
  storageBucket: "st6-combo-maker.firebasestorage.app",
  messagingSenderId: "945906359459",
  appId: "1:945906359459:web:59a955b609426cf2893316",
  measurementId: "G-YVFY7H6N9E"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const charSelect = document.getElementById("char-select");
const comboArea = document.getElementById("combo-area");
const addRowBtn = document.getElementById("add-row-btn");
const saveFirestoreBtn = document.getElementById("save-firestore-btn");

let characters = ["ルーク","ジェイミー","マノン","キンバリー","マリーザ","リリー","JP","ジュリ","DJ","キャミィ","リュウ","本田","ブランカ","ガイル","ケン","春麗","ザンギエフ","ダルシム","ラシード","AKI","エド","豪鬼","ベガ","テリー","舞","エレナ","サガット","ヴァイパー","アレックス","イングリッド"];
let moveListMap = {};
let rowCount = 0;
let currentChar = characters[0];
let imageMap = {};

const charFolderMap = {
  "ルーク": "luke","ジェイミー": "jamie","マノン": "manon","キンバリー": "kimberly","マリーザ": "marisa","リリー": "lily","JP": "jp",
  "ジュリ": "juri","DJ": "dj","キャミィ": "cammy","リュウ": "ryu","本田": "honda","ブランカ": "blanka","ガイル": "guile","ケン": "ken","春麗": "chunli",
  "ザンギエフ": "zangief","ダルシム": "dhalsim","ラシード": "rashid","AKI": "aki","エド": "ed","豪鬼": "gouki","ベガ": "vega","テリー": "terry",
  "舞": "mai","エレナ": "elena","サガット": "sagat","ヴァイパー": "viper","アレックス": "alex","イングリッド": "ingrid"
};

// ここに moveListMap を既存コード通りに追加（省略）
   moveListMap["リュウ"] = ["5弱P","2弱P","5弱K","2弱K",
  "5中P","6中P","2中P","5中K","2中K",
  "5強P","4強P","6強P","2強P","5強K","4強K","6強K","2強K",
  "不破三連撃","上段二連撃",
  "弱波動拳","中波動拳","強波動拳","OD波動拳",
  "弱昇龍拳","中昇龍拳","強昇龍拳","OD昇龍拳",
  "弱上段足刀蹴り","中上段足刀蹴り","強上段足刀蹴り","OD上段足刀蹴り",
  "弱波掌撃","中波掌撃","強波掌撃","OD波掌撃",
  "弱竜巻旋風脚","中竜巻旋風脚","強竜巻旋風脚","OD竜巻旋風脚","空中竜巻旋風脚",
  "電刃錬気",
  "SA1","SA2","SA3",
  "ドライブラッシュ","cDR","ドライブインパクト","投げ","ジャンプ","前ステップ","ディレイ",
  "J弱P","J中P","J強P","J弱K","J中K","J強K","ここまで1コンボ"];
moveListMap["サガット"] = [
    "5弱P","2弱P","5弱K","6弱K","2弱K",
  "5中P","6中P","2中P","5中K","2中K",
  "5強P","4強P","2強P","5強K","5強K(1段目)","6強K","2強K",
  "2中P＞2強P","2中P＞2強K","5中K＞5強K","5中P＞5強K",
  "弱タイガーショット","中タイガーショット","強タイガーショット","OD上タイガーショット","OD下タイガーショット",
  "弱タイガーアパカ","中タイガーアパカ","強タイガーアパカ","溜めアパカ","ODタイガーアパカ",
  "弱タイガーニー","中タイガーニー","強タイガーニー","ODタイガーニー",
  "弱タイガーネクサス","中タイガーネクサス","強タイガーネクサス","ODタイガーネクサス",
  "弱派生","中派生","強派生",
  "SA1","SA2","SA3",
  "ドライブラッシュ","cDR","ドライブインパクト","投げ","ジャンプ","前ステップ","ディレイ",
  "J弱P","J中P","J強P","J弱K","J中K","J強K","ここまで1コンボ"];
moveListMap["AKI"] = ["5弱P","2弱P","5弱K","2弱K",
      "5中P","3中P","2中P","5中K","2中K",
      "5強P","6強P","2強P","5強K","6強K","2強K",
      "5弱P5弱P","5強P5強P",
      "弱紫煙砲","中紫煙泉","強紫煙撒","OD紫煙砲","紫煙追",
      "弱凶襲突","中凶襲突","強凶襲突","OD凶襲突",
      "弱蛇頭鞭","中蛇頭鞭","強蛇頭鞭","OD蛇頭鞭",
      "弱蛇軽功","中蛇軽功","強蛇軽功","OD蛇軽功",
      "猛毒牙","蛇連咬","雁字搦",
      "SA1","SA2","SA3",
      "ドライブラッシュ","cDR","ドライブインパクト","投げ","ジャンプ","前ステップ","ディレイ",
      "J弱P","J中P","J強P","J弱K","J中K","J強K","ここまで1コンボ"];
moveListMap["ルーク"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];
moveListMap["ジェイミー"] = ["5弱P","2弱P","5弱K","2弱K",
  "5中P","2中P","5中K","6中K","2中K","2KK",
  "5強P","4強P","2強P","5強K","6強K","2強K",
  "2強K＞2強K","2強K＞2強K＞P","5弱P＞5弱K＞5中P","4強P＞5強P＞5強K","6強K＞4強K＞P",
  "弱流酔拳","中流酔拳","強流酔拳","OD流酔拳",
  "流酔拳派生","流酔拳派生2段目","流酔脚派生","流酔脚派生2段目",
  "弱酔疾歩","中酔疾歩","強酔疾歩","OD酔疾歩","疾歩仙掌",
  "弱張弓腿","中張弓腿","強張弓腿","OD張弓腿",
  "弱爆廻","中爆廻","強爆廻","OD爆廻",
  "弱無影蹴","中無影蹴","強無影蹴","OD無影蹴",
  "点辰","OD点辰",
  "SA1","SA2","SA3",
  "ドライブラッシュ","cDR","ドライブインパクト","投げ","ジャンプ","前ステップ","ディレイ",
  "J弱P","J中P","J強P","J弱K","J中K","J強K","ここまで1コンボ"];
moveListMap["マノン"] = ["5弱P","2弱P","5弱K","2弱K",
  "5中P","2中P","5中K","4中K","2中K",
  "5強P","4強P","2強P","5強K","2強K","3強K",
  "5中P＞5中K","4中K＞5中K","5強P＞5強P","2強P＞5強P",
  "弱マネージュ・ドレ","中マネージュ・ドレ","強マネージュ・ドレ","ODマネージュ・ドレ",
  "弱ロン・ポワン","中ロン・ポワン","強ロン・ポワン","ODロン・ポワン",
  "弱デガジェ","中デガジェ","強デガジェ","ODデガジェ",
  "弱ランヴェルセ","中ランヴェルセ","強ランヴェルセ","ODランヴェルセ","グラン・フェッテ","ODグラン・フェッテ",
  "SA1","SA2","SA3",
  "ドライブラッシュ","cDR","ドライブインパクト","投げ","ジャンプ","前ステップ","ディレイ",
  "J弱P","J中P","J強P","J弱K","J中K","J強K","ここまで1コンボ"];
moveListMap["キンバリー"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];
moveListMap["マリーザ"] = ["5弱P","2弱P","5弱K","2弱K",
  "5中P","6中P","2中P","5中K","2中K",
  "5強P","4強P","2強P","3強P","5強K","6強K","2強K",
  "5弱P＞5弱P","5中P＞5中P","5強P＞5強P","6中P＞5強P","6中P＞5強K","6強K＞6強K",
  "弱グラディウス","中グラディウス","強グラディウス","ODグラディウス",
  "弱ディマカイルス","中ディマカイルス","強ディマカイルス","ODディマカイルス","ディマカイルス派生",
  "弱ファランクス","中ファランクス","強ファランクス","ODファランクス",
  "弱クアドリガ","中クアドリガ","強クアドリガ","ODクアドリガ",
  "スクトゥム","ODスクトゥム","トニトルス","プロケッラ","エンフォルド",
  "SA1","SA2","SA3",
  "ドライブラッシュ","cDR","ドライブインパクト","投げ","ジャンプ","前ステップ","ディレイ",
  "J弱P","J中P","J強P","J2強P","J弱K","J中K","J強K",
  "溜め5強P","溜め4強P","溜め2強P","溜め3強P","溜め5強K","溜め6強K","溜め2強K","ここまで1コンボ"];
moveListMap["JP"] = ["5弱P","2弱P","5弱K","2弱K",
  "5中P","4中P","2中P","5中K","6中K","2中K",
  "5強P","2強P","3強P","5強K","6強K","2強K",
  "4中P＞5中P","5強K＞5強P","5強K＞5強P＞5強P","5強K＞5強P＞5強K",
  "弱トリグラフ","中トリグラフ","強トリグラフ","弱中トリグラフ","弱強トリグラフ","中強トリグラフ",
  "弱ストリボーグ","中ストリボーグ","強ストリボーグ","ODストリボーグ",
  "弱ヴィーハト","中ヴィーハト","強ヴィーハト","弱中ヴィーハト","弱強ヴィーハト","中強ヴィーハト",
  "弱ヴィーハトアクノ","中ヴィーハトアクノ","ヴィーハトチェーニ","起爆HIT",
  "アムネジア","ODアムネジア",
  "弱トルバラン","中トルバラン","強トルバラン","ODトルバラン",
  "アブニマーチ","ODアブニマーチ",
  "SA1","SA2","SA3",
  "ドライブラッシュ","cDR","ドライブインパクト","投げ","微歩き","前ステップ","前ジャンプ","バクステ","ディレイ",
  "J弱P","J中P","J強P","J弱K","J中K","J強K","ここまで1コンボ"];
moveListMap["ジュリ"] = ["5弱P","2弱P","5弱K","2弱K",
  "5中P","6中P","2中P","5中K","5中K(1段目)","6中K","2中K",
  "5強P","6強P","2強P","5強K","4強K","4強K(2段目)","2強K",
  "5中P＞4強P","5中P＞4強P＞5強P",
  "弱風破刃","中風破刃","強風破刃","OD風破刃",
  "歳破衝","強化歳破衝","OD歳破衝",
  "暗剣殺","強化暗剣殺","OD暗剣殺",
  "五黄殺","強化五黄殺","OD五黄殺",
  "弱天穿輪","中天穿輪","強天穿輪","OD天穿輪",
  "疾空閃","OD疾空閃","死連閃",
  "SA1","SA2","SA3",
  "ドライブラッシュ","cDR","ドライブインパクト","投げ","前ジャンプ","前ステップ","バクステ","ディレイ",
  "J弱P","J中P","J強P","垂直J強P","J弱K","J中K","J強K","ここまで1コンボ",
  "弱派生","強化弱派生","OD弱派生",
  "中派生","強化中派生","OD中派生",
  "強派生","強化強派生","OD強派生"];
moveListMap["キャミィ"] = ["5弱P","2弱P","5弱K","2弱K",
  "5中P","4中P","2中P","5中K","2中K",
  "5強P","2強P","5強K","4強K","6強K","2強K",
  "4中P＞5強K","5強P＞5強K(1段目)","5強P＞5強K",
  "弱スパイラルアロー","中スパイラルアロー","強スパイラルアロー","溜めアロー","ODスパイラルアロー",
  "弱キャノンスパイク","中キャノンスパイク","強キャノンスパイク","溜めスパイク","ODキャノンスパイク",
  "弱アクセルスピンナックル","中アクセルスピンナックル","強アクセルスピンナックル","ODアクセルスピンナックル",
  "弱キャノンストライク","中キャノンストライク","強キャノンストライク","ODキャノンストライク",
  "弱フーリガン","中フーリガン","強フーリガン","溜めフーリガン","ODフーリガン",
  "派生キャノンストライク","派生リバースエッジ","派生レイザーエッジスライサー","派生投げ",
  "SA1","SA2","SA3",
  "ドライブラッシュ","cDR","ドライブインパクト","投げ","ジャンプ","前ステップ","ディレイ",
  "J弱P","J中P","J強P","J弱K","J中K","J強K","ここまで1コンボ"];
moveListMap["本田"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];
moveListMap["ブランカ"] = ["5弱P","2弱P","5弱K","2弱K",
      "5中P","6中P","2中P","5中K","4中K","6中K","2中K",
      "5強P","6強P","2強P","3強P","5強K","2強K",
      "エレクトリックサンダー","ODエレクトリックサンダー",
      "弱バックステップローリング","中バックステップローリング","強バックステップローリング","ODバックステップローリング",
      "弱ローリングアタック","中ローリングアタック","強ローリングアタック","ODローリングアタック",
      "弱エリアルローリング","中エリアルローリング","強エリアルローリング","ODエリアルローリング",
      "弱バーチカルローリング","中バーチカルローリング","強バーチカルローリング","ODバーチカルローリング",
      "フィアーダウン","ワイルドリフト","レイドジャンプ","ワイルドハント","ODワイルドハント",
      "1P","2P","3P","4P","6P","7P","8P","9P",
      "ブランカちゃん爆弾","ブランカちゃんHIT","サプライズフォワード","サプライズバック",
      "SA1","SA2","SA3",
      "ドライブラッシュ","cDR","ドライブインパクト","投げ","前ステップ","バックジャンプ","ディレイ",
      "J弱P","J中P","J強P","J弱K","J中K","J強K","垂直J強P","ここまで1コンボ"];
moveListMap["ガイル"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];
moveListMap["ケン"] = ["5弱P","2弱P","5弱K","2弱K",
      "5中P","2中P","5中K","2中K",
      "5強P","2強P","5強K","2強K",
      "5中P＞5強P","5中K＞5中K","5中K＞5中K＞5強K",
      "急停止","紫電カカト落とし","踏み込み前蹴り",
      "弱波動拳","中波動拳","強波動拳","OD波動拳",
      "弱昇龍拳","中昇龍拳","強昇龍拳","OD昇龍拳","【奮迅】昇龍拳",
      "弱竜巻旋風脚","中竜巻旋風脚","強竜巻旋風脚","OD竜巻旋風脚","【奮迅】竜巻旋風脚",
      "弱龍尾脚","中龍尾脚","強龍尾脚","OD龍尾脚","【奮迅】龍尾脚",
      "弱迅雷脚","中迅雷脚","強迅雷脚","OD迅雷脚",
      "弱派生","中派生","強派生","OD弱派生","OD中派生","OD強派生","OD弱派生(2段目)","OD中派生(2段目)","OD強派生(2段目)",
      "SA1","SA2","SA3",
      "ドライブラッシュ","cDR","ドライブインパクト","投げ","ジャンプ","前ステップ","ディレイ",
      "J弱P","J中P","J強P","J弱K","J中K","J強K","垂直J強K","空中竜巻旋風脚","OD空中竜巻旋風脚","ここまで1コンボ"];
moveListMap["春麗"] = ["5弱P","2弱P","5弱K","2弱K",
      "5中P","6中P","2中P","5中K","2中K",
      "5強P","4強P","3強P","2強P","5強K","6強K","2強K","3強K",
      "弱気功拳","中気功拳","強気功拳","OD気功拳",
      "弱百裂脚","中百裂脚","強百裂脚","OD百裂脚",
      "弱スピニングバードキック","中スピニングバードキック","強スピニングバードキック","ODスピニングバードキック",
      "弱覇山蹴","中覇山蹴","強覇山蹴","OD覇山蹴",
      "弱天昇脚","中天昇脚","強天昇脚","OD天昇脚",
      "構え弱P","構え中P","構え強P","構え弱K","構え中K","構え強K",
      "SA1","SA2","SA3",
      "ドライブラッシュ","cDR","ドライブインパクト","投げ","ジャンプ","前ステップ","ディレイ",
      "J弱P","J中P","J強P","J強P(2段目)","J弱K","J中K","J2中K","J強K","垂直J強K","ここまで1コンボ"];
moveListMap["ザンギエフ"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];
moveListMap["ダルシム"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];
moveListMap["ラシード"] = ["5弱P","2弱P","5弱K","2弱K",
  "5中P","6中P","2中P","5中K","2中K",
  "5強P","6強P","2強P","5強K","6強K","2強K",
  "5中P＞5強P",
  "弱スピニング・ミキサー","中スピニング・ミキサー","強スピニング・ミキサー","ODスピニング・ミキサー",
  "弱イーグル・スパイク","中イーグル・スパイク","強イーグル・スパイク","ODイーグル・スパイク",
  "弱ワールウインド・ショット","中ワールウインド・ショット","強ワールウインド・ショット","ODワールウインド・ショット",
  "弱アラビアン・サイクロン","中アラビアン・サイクロン","強アラビアン・サイクロン","ODアラビアン・サイクロン",
  "ウイング・ストローク","アサルト・ロール","アサルト・ネイル",
  "弱アラビアン・スカイハイ","中アラビアン・スカイハイ","強アラビアン・スカイハイ","ODアラビアン・スカイハイ",
  "バックアップ","テンペスト・ムーン","サイド・フリップ","フロント・フリップ",
  "SA1","SA2","SA3",
  "ドライブラッシュ","cDR","ドライブインパクト","投げ","前ジャンプ","前ステップ","バクステ","RUN","ディレイ",
  "J弱P","J中P","J強P","J2強P","J弱K","J中K","J強K","J7強K","ここまで1コンボ",
  "溜め弱ワール","溜め中ワール","溜め強ワール","溜めODワール",
  "強化弱ミキサー","強化中ミキサー","強化強ミキサー","強化ODミキサー",
  "強化弱スパイク","強化中スパイク","強化強スパイク","強化ODスパイク"];
moveListMap["エド"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];
moveListMap["豪鬼"] = ["5弱P","2弱P","5弱K","2弱K",
  "5中P","6中P","2中P","5中K","6中K","2中K",
  "5強P","6強P","2強P","5強K","4強K","2強K",
  "5中P＞5強P","6強P＞5強P","6強P＞5強P＞5強K","5中K＞5強K",
  "弱豪波動拳","中豪波動拳","強豪波動拳","OD豪波動拳",
  "弱豪昇龍拳","中豪昇龍拳","強豪昇龍拳","OD豪昇龍拳",
  "弱竜巻斬空脚","中竜巻斬空脚","強竜巻斬空脚","OD竜巻斬空脚","空中竜巻斬空脚","OD空中竜巻斬空脚",
  "弱金剛灼火","中金剛灼火","強金剛灼火","OD金剛灼火","金剛灼火派生",
  "弱百鬼襲","中百鬼襲","強百鬼襲","OD百鬼襲",
  "百鬼豪斬","百鬼豪衝","百鬼豪刃",
  "前阿修羅閃空","後ろ阿修羅閃空","朧",
  "SA1","空中SA1","SA2","SA3","瞬獄殺",
  "ドライブラッシュ","cDR","ドライブインパクト","投げ","ジャンプ","前ステップ","微歩き","ディレイ",
  "J弱P","J中P","J強P","J弱K","J中K","J2中K","J強K","ここまで1コンボ",
  "弱斬空波動拳","中斬空波動拳","強斬空波動拳","OD斬空波動拳",
  "弱豪波動拳(Lv2)","中豪波動拳(Lv2)","強豪波動拳(Lv2)","OD豪波動拳(Lv2)"];
moveListMap["ベガ"] = ["5弱P","2弱P","5弱K","2弱K",
      "5中P","2中P","5中K","2中K",
      "5強P","6強P","2強P","5強K","4強K","2強K","3強K",
      "5中P＞6強P","5中P＞2強K",
      "弱サイコクラッシャーアタック","中サイコクラッシャーアタック","強サイコクラッシャーアタック","ODサイコクラッシャーアタック",
      "弱ダブルニープレス","中ダブルニープレス","強ダブルニープレス","ODダブルニープレス",
      "弱バックフィストコンボ","中バックフィストコンボ","強バックフィストコンボ","ODバックフィストコンボ",
      "弱シャドウライズ","中シャドウライズ","強シャドウライズ","ODシャドウライズ",
      "ヘッドプレス","ODヘッドプレス","サマーソルトスカルダイバー","デビルリバース","ODデビルリバース",
      "起爆",
      "SA1","SA2","SA3",
      "ドライブラッシュ","cDR","ドライブインパクト","投げ","前ステップ","ディレイ",
      "J弱P","J中P","J強P","J弱K","J中K","J強K","J中P＞J中P","ここまで1コンボ"];
moveListMap["テリー"] = ["5弱P","2弱P","5弱K","2弱K",
  "5中P","2中P","5中K","2中K",
  "5強P","5強P(1HIT)","6強P","2強P","5強K","2強K",
  "2中K＞2強K","5中P＞5強P","5中P＞5強K","5中P＞5強K＞5強K","5中P＞5中K","5中P＞5中K＞5中P","5中P＞5中K＞5中K",
  "弱パワーウェイブ","中パワーウェイブ","ラウンドウェイブ","ODパワーウェイブ",
  "弱ライジングタックル","中ライジングタックル","強ライジングタックル","ODライジングタックル",
  "クイックバーン","ODクイックバーン","中バーンナックル","強バーンナックル","ODバーンナックル",
  "弱パワーチャージ","中パワーチャージ","強パワーチャージ","ODパワーチャージ",
  "弱クラックシュート","中クラックシュート","強クラックシュート","ODクラックシュート",
  "SA1","SA2","SA2(追加入力)","SA3",
  "ドライブラッシュ","cDR","ドライブインパクト","投げ","ジャンプ","前ステップ","ディレイ",
  "J弱P","J中P","J強P","J弱K","J中K","J強K","ここまで1コンボ"];
moveListMap["舞"] = ["5弱P","2弱P","5弱K","2弱K",
  "5中P","6中P","2中P","5中K","2中K",
  "5強P","2強P","5強K","4強K","2強K",
  "5弱K＞5弱K＞5弱K","4強K＞5強K",
  "弱花蝶扇","中花蝶扇","強花蝶扇","OD花蝶扇",
  "弱龍炎舞","中龍炎舞","強龍炎舞","OD龍炎舞",
  "弱必殺忍蜂","中必殺忍蜂","強必殺忍蜂","OD必殺忍蜂",
  "弱飛翔龍炎陣","中飛翔龍炎陣","強飛翔龍炎陣","OD飛翔龍炎陣",
  "ムササビの舞","ODムササビの舞",
  "SA1","SA2","SA3",
  "ドライブラッシュ","cDR","ドライブインパクト","投げ","ジャンプ","前ステップ","ディレイ",
  "J弱P","J中P","J強P","J弱K","J中K","J強K","ここまで1コンボ",
  "溜め弱花蝶扇","溜め中花蝶扇","溜め強花蝶扇","溜めOD花蝶扇","乱れ花蝶扇"];
moveListMap["エレナ"] = [ "5弱P","2弱P","5弱K","2弱K",
  "5中P","2中P","5中K","6中K","2中K",
  "5強P","6強P","2強P","5強K","4強K","2強K","3強K",
  "5中P＞5中P","5中K＞5強K","2中K＞5強K","5強P＞5強P","6強P＞5強P＞5強P",
  "弱ライノホーン","中ライノホーン","強ライノホーン","ODライノホーン",
  "弱スクラッチホイール","中スクラッチホイール","強スクラッチホイール","ODスクラッチホイール",
  "弱スピンサイズ","中スピンサイズ","強スピンサイズ","ODスピンサイズ",
  "弱リンクシング","中リンクシング","強リンクシング","ODリンクシング",
  "弱リンクスワール","中リンクスワール","強リンクスワール",
  "レオパードスナップ","ハーベストサークル","マレットスマッシュ",
  "強化レオパードスナップ","強化ハーベストサークル","強化マレットスマッシュ",
  "弱ムーングライド","中ムーングライド","強ムーングライド","ODムーングライド","ムーングライド派生",
  "SA1","SA2","SA3",
  "ドライブラッシュ","cDR","ドライブインパクト","投げ","ジャンプ","前ステップ","ディレイ",
  "J弱P","J中P","J強P","J弱K","J中K","J強K","ここまで1コンボ"];
moveListMap["ヴァイパー"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];
moveListMap["アレックス"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];
moveListMap["イングリッド"] = ["5弱P", "2弱P", "波動拳", "昇龍拳", "竜巻旋風脚"];


characters.forEach(c=>{
  const o=document.createElement("option");
  o.value=c; o.textContent=c;
  charSelect.appendChild(o);
});

let unsubscribe = null;
function startRealtimeListener(char){
  if(unsubscribe) unsubscribe();
  const docRef = doc(db,"combos",char);
  unsubscribe = onSnapshot(docRef, (docSnap)=>{
    if(docSnap.exists()){
      const data = docSnap.data().rows || [];
      comboArea.innerHTML=""; rowCount=0;
      data.forEach(r=>addRow(r));
    } else { comboArea.innerHTML=""; rowCount=0; }
  });
}

function updateImageMap(){
  imageMap = {};
  (moveListMap[currentChar] || []).forEach(move=>{
    const folder = charFolderMap[currentChar];
    imageMap[move] = `images/${folder}/${move}.png`;
  });
}

charSelect.addEventListener("change",()=>{
  currentChar = charSelect.value;
  updateImageMap();
  startRealtimeListener(currentChar);
});

addRowBtn.addEventListener("click",()=>addRow());

saveFirestoreBtn.addEventListener("click", async()=>{
  const data = getCurrentData();
  await setDoc(doc(db,"combos",currentChar), {rows:data});
  alert("Firestoreに保存しました");
});

function getCurrentData(){
  return [...comboArea.querySelectorAll(".combo-row")].map(row=>{
    return {title: row.querySelector(".row-title").value,
            moves: [...row.querySelectorAll(".image-box img")].map(img=>img.alt)};
  });
}

function addRow(savedData=null){
  rowCount++;
  const rowDiv=document.createElement("div"); rowDiv.classList.add("combo-row"); rowDiv.draggable=true;

  const header=document.createElement("div"); header.classList.add("row-header");
  const titleInput=document.createElement("input"); titleInput.type="text"; titleInput.value=savedData?.title||`コンボ${rowCount}`; titleInput.classList.add("row-title");
  const deleteBtn=document.createElement("button"); deleteBtn.textContent="×段削除"; deleteBtn.classList.add("row-delete-btn"); deleteBtn.addEventListener("click",()=>rowDiv.remove());
  const duplicateBtn=document.createElement("button"); duplicateBtn.textContent="複製"; duplicateBtn.classList.add("row-duplicate-btn"); 
  duplicateBtn.addEventListener("click",()=>duplicateRow(rowDiv));
  header.append(titleInput,deleteBtn,duplicateBtn);

  const controls=document.createElement("div"); controls.classList.add("controls");
  const select=document.createElement("select");
  const defaultOption=document.createElement("option"); defaultOption.value=""; defaultOption.textContent="技を選択してください"; select.appendChild(defaultOption);
  (moveListMap[currentChar] || []).forEach(move=>{ const o=document.createElement("option"); o.value=move; o.textContent=move; select.appendChild(o); });
  const addBtn=document.createElement("button"); addBtn.textContent="追加"; controls.append(select,addBtn);

  const container=document.createElement("div"); container.classList.add("image-container");
  addBtn.addEventListener("click",()=>{ const move=select.value; if(move && imageMap[move]) addImageBox(container,move); });
  if(savedData?.moves) savedData.moves.forEach(m=>addImageBox(container,m));

  rowDiv.append(header,controls,container);
  comboArea.appendChild(rowDiv);
  addRowDragAndDrop(rowDiv);
  return rowDiv;
}

function duplicateRow(row){
  const title=row.querySelector(".row-title").value+"_コピー";
  const moves=[...row.querySelectorAll(".image-box img")].map(img=>img.alt);
  const newRow=addRow({title,moves});
  row.after(newRow);
}

function addImageBox(container,move){
  const box=document.createElement("div"); box.classList.add("image-box"); box.draggable=true;
  const img=document.createElement("img"); img.src=imageMap[move]; img.alt=move;
  const delBtn=document.createElement("button"); delBtn.textContent="×"; delBtn.classList.add("delete-btn"); delBtn.addEventListener("click",()=>box.remove());
  box.append(img,delBtn); container.appendChild(box);
  addImageDragAndDrop(box,container);
}

function addImageDragAndDrop(element,container){
  let guide;
  element.addEventListener("dragstart",(e)=>{
    e.dataTransfer.setData("text/plain","");
    element.classList.add("dragging");
    guide=document.createElement("div"); guide.classList.add("drag-guide"); container.appendChild(guide);
  });
  element.addEventListener("dragend",(e)=>{
    element.classList.remove("dragging");
    if(guide){ 
      const after=getDragAfterElement(container,e.clientX);
      if(after) container.insertBefore(element,after);
      else container.appendChild(element);
      guide.remove();
    }
  });
  container.addEventListener("dragover",(e)=>{
    e.preventDefault();
    const after=getDragAfterElement(container,e.clientX);
    if(guide){
      guide.style.display="block";
      guide.style.left= after ? after.offsetLeft+"px" : (container.offsetWidth-4)+"px";
    }
  });
}
function getDragAfterElement(container,x){
  const elements=[...container.querySelectorAll(".image-box:not(.dragging)")];
  return elements.find(el=>x<el.getBoundingClientRect().left+el.getBoundingClientRect().width/2);
}

function addRowDragAndDrop(row){
  let guide;
  row.querySelectorAll("input, textarea").forEach(el=>{
    el.addEventListener("mousedown",()=>{ row.draggable=false; });
    el.addEventListener("mouseup",()=>{ row.draggable=true; });
  });

  let lastY=0;
  row.addEventListener("dragstart",(e)=>{
    e.dataTransfer.setData("text/plain","");
    row.classList.add("row-dragging");
    guide=document.createElement("div"); guide.classList.add("row-drag-guide"); comboArea.appendChild(guide);
  });
  row.addEventListener("dragend",(e)=>{
    row.classList.remove("row-dragging");
    if(guide){ 
      const after=getDragAfterRow(comboArea,lastY);
      if(after) comboArea.insertBefore(row,after);
      else comboArea.appendChild(row);
      guide.remove();
    }
  });
  comboArea.addEventListener("dragover",(e)=>{
    e.preventDefault();
    lastY=e.clientY;
    const after=getDragAfterRow(comboArea,lastY);
    if(guide){
      guide.style.display="block";
      guide.style.top= after ? after.getBoundingClientRect().top+"px" : comboArea.getBoundingClientRect().bottom+"px";
    }
  });
}
function getDragAfterRow(container,y){
  const rows=[...container.querySelectorAll(".combo-row:not(.row-dragging)")];
  return rows.find(r=>y<r.getBoundingClientRect().top+r.getBoundingClientRect().height/2);
}

updateImageMap();
startRealtimeListener(currentChar);
</script>
</body>
</html>
