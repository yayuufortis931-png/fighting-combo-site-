<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>æ˜¥éº— ã‚³ãƒ³ãƒœç®¡ç†</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
#page-nav { margin-bottom: 20px; }
#page-nav button, #add-page-btn, #save-btn, #back-main, #add-row-btn {
  margin-right: 8px; padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer;
  background: #666; color: white; transition: background 0.2s;
}
#page-nav button:hover, #add-page-btn:hover, #save-btn:hover, #back-main:hover, #add-row-btn:hover { background: #444; }
#page-nav button[style*="bold"] { background: #333; }
.combo-row {
  margin-bottom: 20px; padding: 12px; border: 2px solid #666; border-radius: 8px;
  background: #fff; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: grab;
}
.combo-row.placeholder {
  border: 2px dashed #2196f3; background: #e0f0ff; min-height: 80px;
}
.row-header { display: flex; justify-content: flex-start; align-items: center; gap: 6px; flex-wrap: wrap; margin-bottom: 10px; }
.row-title { font-weight: bold; font-size: 15px; padding: 4px; flex: 1; }
.action-btn { border: none; border-radius: 5px; padding: 4px 8px; cursor: pointer; color: white; font-size: 13px; }
.delete { background: #e53935; }
.duplicate { background: #ff9800; }
.copy { background: #43a047; }
.controls { margin: 10px 0; display: flex; gap: 8px; flex-wrap: wrap; }
.image-container { display: flex; gap: 10px; flex-wrap: wrap; position: relative; }
.image-box { position: relative; width: 100px; height: 100px; border: 1px solid #ccc; border-radius: 6px; overflow: hidden; background: #fafafa; }
.image-box img { width: 100%; height: 100%; object-fit: contain; }
.delete-btn { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; }
.combo-output { display: flex; align-items: center; gap: 6px; margin-top: 10px; background: #f9f9f9; padding: 6px 8px; border-radius: 5px; border: 1px solid #ccc; font-family: monospace; font-size: 14px; }
.combo-text { flex: 1; text-align: left; }
</style>
</head>
<body>
<h2>æ˜¥éº— ã‚³ãƒ³ãƒœç®¡ç†</h2>
<div id="page-nav"></div>
<button id="add-page-btn">ï¼‹ ãƒšãƒ¼ã‚¸è¿½åŠ </button>
<button id="save-btn">ğŸ’¾ ä¿å­˜</button>
<button id="back-main">ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</button>
<button id="add-row-btn">ï¼‹ æ®µã‚’è¿½åŠ </button>
<div id="combo-area"></div>

<script>
// ====== å…±é€šå¤‰æ•° ======
const comboArea = document.getElementById("combo-area");
const pageNav = document.getElementById("page-nav");
const addPageBtn = document.getElementById("add-page-btn");
const saveBtn = document.getElementById("save-btn");
const backMainBtn = document.getElementById("back-main");
const addRowBtn = document.getElementById("add-row-btn");

let pages = ["default","recommended"];
let currentPage = pages[0];
let rowCount = 0;

// ====== æ˜¥éº—æŠ€ãƒªã‚¹ãƒˆ ======
const moveList = [
  "5å¼±P","2å¼±P","5å¼±K","2å¼±K",
  "5ä¸­P","6ä¸­P","2ä¸­P","5ä¸­K","2ä¸­K",
  "5å¼·P","4å¼·P","3å¼·P","2å¼·P","5å¼·K","6å¼·K","2å¼·K","3å¼·K",
  "å¼±æ°—åŠŸæ‹³","ä¸­æ°—åŠŸæ‹³","å¼·æ°—åŠŸæ‹³","ODæ°—åŠŸæ‹³",
  "å¼±ç™¾è£‚è„š","ä¸­ç™¾è£‚è„š","å¼·ç™¾è£‚è„š","ODç™¾è£‚è„š",
  "å¼±ã‚¹ãƒ”ãƒ‹ãƒ³ã‚°ãƒãƒ¼ãƒ‰ã‚­ãƒƒã‚¯","ä¸­ã‚¹ãƒ”ãƒ‹ãƒ³ã‚°ãƒãƒ¼ãƒ‰ã‚­ãƒƒã‚¯","å¼·ã‚¹ãƒ”ãƒ‹ãƒ³ã‚°ãƒãƒ¼ãƒ‰ã‚­ãƒƒã‚¯","ODã‚¹ãƒ”ãƒ‹ãƒ³ã‚°ãƒãƒ¼ãƒ‰ã‚­ãƒƒã‚¯",
  "å¼±è¦‡å±±è¹´","ä¸­è¦‡å±±è¹´","å¼·è¦‡å±±è¹´","ODè¦‡å±±è¹´",
  "å¼±å¤©æ˜‡è„š","ä¸­å¤©æ˜‡è„š","å¼·å¤©æ˜‡è„š","ODå¤©æ˜‡è„š",
  "æ§‹ãˆå¼±P","æ§‹ãˆä¸­P","æ§‹ãˆå¼·P","æ§‹ãˆå¼±K","æ§‹ãˆä¸­K","æ§‹ãˆå¼·K",
  "SA1","SA2","SA3",
  "ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒƒã‚·ãƒ¥","ãƒ‰ãƒ©ã‚¤ãƒ–ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ","æŠ•ã’","ã‚¸ãƒ£ãƒ³ãƒ—","å‰ã‚¹ãƒ†ãƒƒãƒ—",
  "Jå¼±P","Jä¸­P","Jå¼·P","Jå¼·P(2æ®µç›®)","Jå¼±K","Jä¸­K","J2ä¸­K","Jå¼·K","å‚ç›´Jå¼·K"
  ]; 

const imageMap = {}; moveList.forEach(m=>imageMap[m]=`images/chunli/${m}.png`);

// ====== ãƒšãƒ¼ã‚¸åˆ‡æ›¿ ======
function renderPageNav(){
  pageNav.innerHTML="";
  pages.forEach(p=>{
    const btn=document.createElement("button"); btn.textContent=p;
    if(p==="recommended") btn.addEventListener("click",()=>location.href="chunli_recommended.html");
    else btn.addEventListener("click",()=>{ saveCurrentPage(); currentPage=p; loadPage(); renderPageNav(); });
    if(p===currentPage) btn.style.fontWeight="bold";
    pageNav.appendChild(btn);
  });
}
renderPageNav();

// ====== ãƒšãƒ¼ã‚¸è¿½åŠ  ======
addPageBtn.addEventListener("click",()=>{
  const name=prompt("æ–°ã—ã„ãƒšãƒ¼ã‚¸åã‚’å…¥åŠ›"); if(!name) return;
  if(pages.includes(name)){ alert("ã™ã§ã«å­˜åœ¨ã™ã‚‹ãƒšãƒ¼ã‚¸åã§ã™"); return; }
  pages.push(name); currentPage=name; loadPage(); renderPageNav();
});

// ====== æˆ»ã‚‹ ======
backMainBtn.addEventListener("click",()=>location.href="index.html");

// ====== ä¿å­˜ ======
saveBtn.addEventListener("click",()=>{ saveCurrentPage(); alert("ä¿å­˜ã—ã¾ã—ãŸï¼"); });
function saveCurrentPage(){
  const data=[...document.querySelectorAll(".combo-row")].map(row=>({
      title: row.querySelector(".row-title").value,
      moves: [...row.querySelectorAll(".image-box img")].map(img=>img.alt)
  }));
  localStorage.setItem(`comboData_chunli_${currentPage}`,JSON.stringify(data));
}

// ====== ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ ======
function loadPage(){
  comboArea.innerHTML=""; rowCount=0;
  const data=JSON.parse(localStorage.getItem(`comboData_chunli_${currentPage}`)||"[]");
  data.forEach(d=>addRow(d));
}
loadPage();

// ====== æ®µè¿½åŠ  ======
addRowBtn.addEventListener("click",()=>addRow());
function addRow(savedData=null){
  rowCount++;
  const row=document.createElement("div"); row.className="combo-row"; row.draggable=true;

  // header
  const header=document.createElement("div"); header.className="row-header";
  const title=document.createElement("input"); title.type="text"; title.value=savedData?.title||`ã‚³ãƒ³ãƒœ${rowCount}`; title.className="row-title";
  const del=makeBtn("å‰Šé™¤","delete",()=>row.remove());
  const dup=makeBtn("è¤‡è£½","duplicate",()=>duplicateRow(row));
  header.append(title,del,dup);
  row.appendChild(header);

  // controls
  const controls=document.createElement("div"); controls.className="controls";
  const select=document.createElement("select");
  const def=document.createElement("option"); def.value=""; def.textContent="æŠ€ã‚’é¸æŠ"; select.append(def);
  moveList.forEach(m=>{ const o=document.createElement("option"); o.value=m; o.textContent=m; select.append(o); });
  const addBtn=document.createElement("button"); addBtn.textContent="è¿½åŠ "; controls.append(select,addBtn);
  row.appendChild(controls);

  // image container
  const container=document.createElement("div"); container.className="image-container";
  row.appendChild(container);

  // combo output
  const output=document.createElement("div"); output.className="combo-output";
  const text=document.createElement("div"); text.className="combo-text"; text.textContent=savedData?.moves?.join(" > ")||"";
  const copy=makeBtn("ã‚³ãƒ”ãƒ¼","copy",()=>navigator.clipboard.writeText(text.textContent));
  output.append(text,copy);
  row.appendChild(output);

  // åˆæœŸç”»åƒ
  if(savedData?.moves) savedData.moves.forEach(m=>addImageBox(container,m,row));

  // è¿½åŠ ãƒœã‚¿ãƒ³
  addBtn.addEventListener("click",()=>{ if(select.value) addImageBox(container,select.value,row); });

  // æ®µãƒ‰ãƒ©ãƒƒã‚°
  addRowDragAndDrop(row);

  comboArea.appendChild(row);
  return row;
}

// ====== è¤‡è£½ ======
function duplicateRow(row){
  const title=row.querySelector(".row-title").value+"_ã‚³ãƒ”ãƒ¼";
  const moves=[...row.querySelectorAll(".image-box img")].map(img=>img.alt);
  const newRow=addRow({title,moves});
  row.after(newRow);
}

// ====== æ±ç”¨ãƒœã‚¿ãƒ³ ======
function makeBtn(label,type,fn){
  const b=document.createElement("button");
  b.textContent=label; b.className=`action-btn ${type}`; b.addEventListener("click",fn);
  return b;
}

// ====== ç”»åƒè¿½åŠ  ======
function addImageBox(container,move,row){
  const box=document.createElement("div"); box.className="image-box";
  const img=document.createElement("img"); img.src=imageMap[move]; img.alt=move;
  const del=document.createElement("button"); del.textContent="Ã—"; del.className="delete-btn";
  del.addEventListener("click",()=>{ box.remove(); updateComboText(row); });
  container.appendChild(box); box.appendChild(img); box.appendChild(del);

  addImageDragAndDrop(box,container,row);
  updateComboText(row);
}

// ====== ç”»åƒãƒ‰ãƒ©ãƒƒã‚°ï¼ˆã‚´ãƒ¼ã‚¹ãƒˆæ–¹å¼ï¼‰ ======
function addImageDragAndDrop(element, container, row){
  let ghost = null;
  let offsetX = 0, offsetY = 0;

  element.addEventListener("mousedown", e=>{
    e.preventDefault();
    offsetX = e.offsetX;
    offsetY = e.offsetY;

    ghost = element.cloneNode(true);
    ghost.style.position = "absolute";
    ghost.style.pointerEvents = "none";
    ghost.style.opacity = "0.6";
    ghost.style.zIndex = 1000;
    ghost.style.width = element.offsetWidth + "px";
    ghost.style.height = element.offsetHeight + "px";
    document.body.appendChild(ghost);
    moveGhost(e.pageX, e.pageY);

    element.style.visibility = "hidden";

    function moveGhost(pageX, pageY){
      ghost.style.left = pageX - offsetX + "px";
      ghost.style.top = pageY - offsetY + "px";
    }

    function onMouseMove(e){
      moveGhost(e.pageX, e.pageY);
    }

    document.addEventListener("mousemove", onMouseMove);

    document.addEventListener("mouseup", function onMouseUp(e){
      document.removeEventListener("mousemove", onMouseMove);
      document.removeEventListener("mouseup", onMouseUp);

      // ãƒ‰ãƒ­ãƒƒãƒ—ä½ç½®åˆ¤å®š
      const boxes = [...container.querySelectorAll(".image-box")].filter(b=>b!==element);
      let inserted = false;
      for(const b of boxes){
        const rect = b.getBoundingClientRect();
        if(e.clientX < rect.left + rect.width/2){
          container.insertBefore(element, b);
          inserted = true;
          break;
        }
      }
      if(!inserted) container.appendChild(element);

      element.style.visibility = "visible";
      ghost.remove();
      ghost = null;
      updateComboText(row);
    });
  });
}

// ====== æ®µãƒ‰ãƒ©ãƒƒã‚° ======
function addRowDragAndDrop(row){
  let placeholder = null;
  row.addEventListener("dragstart", e=>{
    row.classList.add("row-dragging");
    placeholder = document.createElement("div");
    placeholder.className="combo-row placeholder";
    placeholder.style.height = row.offsetHeight + "px";
    row.parentNode.insertBefore(placeholder, row.nextSibling);
    row.style.opacity="0.4";
  });

  row.addEventListener("dragend", e=>{
    row.classList.remove("row-dragging");
    row.style.opacity="1";
    if(placeholder){
      placeholder.parentNode.replaceChild(row, placeholder);
      placeholder=null;
    }
  });

  comboArea.addEventListener("dragover", e=>{
    e.preventDefault();
    const dragging=document.querySelector(".row-dragging");
    if(!dragging || !placeholder) return;
    const after=getDragAfterRow(comboArea,e.clientY);
    if(after) comboArea.insertBefore(placeholder, after);
    else comboArea.appendChild(placeholder);
  });
}

function getDragAfterRow(container,y){
  const els=[...container.querySelectorAll(".combo-row:not(.row-dragging)")];
  if(els.length===0) return null;
  return els.find(el=>y<el.getBoundingClientRect().top + el.getBoundingClientRect().height/2);
}

// ====== ã‚³ãƒ³ãƒœãƒ†ã‚­ã‚¹ãƒˆæ›´æ–° ======
function updateComboText(row){
  const moves=[...row.querySelectorAll(".image-box img")].map(img=>img.alt);
  row.querySelector(".combo-text").textContent=moves.join(" > ");
}
</script>
</body>
</html>
