<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ブランカ コンボ管理</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; }
#page-nav { margin-bottom: 20px; }
#page-nav button { margin-right: 10px; padding: 5px 10px; }
.combo-row { margin-bottom: 25px; padding: 10px; border: 2px solid #666; border-radius: 8px; background: #f0f0f0; position: relative; }
.row-header { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 8px; }
.row-title { font-weight: bold; font-size: 16px; padding: 5px; flex: 1; }
.row-delete-btn, .row-duplicate-btn { background: red; color: white; border: none; border-radius: 5px; padding: 4px 8px; cursor: pointer; flex-shrink: 0; }
.row-duplicate-btn { background: orange; }
.controls { margin: 10px 0; }
.image-container { display: flex; gap: 10px; flex-wrap: wrap; position: relative; }
.image-box { position: relative; width: 120px; height: 120px; border: 2px solid #ccc; border-radius: 8px; overflow: hidden; background: #f9f9f9; cursor: grab; }
.image-box img { width: 120px; height: 120px; object-fit: contain; }
.delete-btn { position: absolute; top: 5px; right: 5px; background: gray; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; }
.drag-guide { width: 4px; background: #007bff; position: absolute; top:0; height:100%; z-index:1000; display:none; }
.row-drag-guide { height: 4px; background: #ff6600; width: 100%; position: absolute; left:0; z-index:1000; display:none; }
</style>
</head>
<body>
<h2>ブランカ コンボ管理</h2>
<div id="page-nav"></div>
<button id="add-page-btn">＋ ページ追加</button>
<button id="save-btn">💾 保存</button>
<button id="back-main">メインページに戻る</button>
<button id="add-row-btn">＋ 段を追加</button>
<div id="combo-area"></div>

<script>
// ====== 共通変数 ======
const comboArea = document.getElementById("combo-area");
const pageNav = document.getElementById("page-nav");
const addPageBtn = document.getElementById("add-page-btn");
const saveBtn = document.getElementById("save-btn");
const backMainBtn = document.getElementById("back-main");
const addRowBtn = document.getElementById("add-row-btn");

const characterId = location.pathname.split("/").pop().replace(".html","");

let pages = ["default","recommended"];
let currentPage = pages[0];
let rowCount = 0;

// ====== ブランカ専用技リスト ======
const moveList = [
  "5弱P","2弱P","5弱K","2弱K",
      "5中P","6中P","2中P","5中K","4中K","6中K","2中K",
      "5強P","6強P","2強P","3強P","5強K","2強K",
      "エレクトリックサンダー","ODエレクトリックサンダー","バックステップローリング","ODバックステップローリング",
      "弱ローリングアタック","中ローリングアタック","強ローリングアタック","ODローリングアタック",
      "弱エリアルローリング","中エリアルローリング","強エリアルローリング","ODエリアルローリング",
      "弱バーチカルローリング","中バーチカルローリング","強バーチカルローリング","ODバーチカルローリング",
      "フィアーダウン","ワイルドリフト","レイドジャンプ",
      "1P","2P","3P","4P","6P","7P","8P","9P",
      "ブランカちゃん爆弾","ブランカちゃんHIT","サプライズフォワード","サプライズバック",
      "SA1","SA2","SA3",
      "ドライブラッシュ","ドライブインパクト","投げ","ディレイ","前ステップ",
      "J弱P","J中P","J強P","J弱K","J中K","J強K","垂直J強P"
];

const imageMap = {};
moveList.forEach(move => { imageMap[move] = `images/${characterId}/${move}.png`; });

// ====== ページ切替 ======
function renderPageNav(){
  pageNav.innerHTML="";
  pages.forEach(p=>{
    const btn=document.createElement("button");
    btn.textContent=p;
    btn.dataset.page=p;

    if(p === "recommended"){
      btn.addEventListener("click",()=>{ location.href = "blanka_recommended.html"; });
    } else {
      btn.addEventListener("click",()=>{
        saveCurrentPage();
        currentPage=p;
        loadPage();
        renderPageNav();
      });
    }

    if(p===currentPage) btn.style.fontWeight="bold";

    if(!["default","recommended"].includes(p)){
      const delBtn=document.createElement("button");
      delBtn.textContent="×";
      delBtn.addEventListener("click",()=>{
        if(!confirm(`ページ「${p}」を削除しますか？`)) return;
        pages = pages.filter(pageName => pageName!==p);
        localStorage.removeItem(`comboData_${characterId}_${p}`);
        if(currentPage===p) currentPage="default";
        loadPage();
        renderPageNav();
      });
      pageNav.appendChild(delBtn);
    }

    pageNav.appendChild(btn);
  });
}
renderPageNav();

// ====== ページ追加 ======
addPageBtn.addEventListener("click",()=>{
  let name=prompt("新しいページ名を入力");
  if(!name) return;
  if(pages.includes(name)){ alert("すでに存在するページ名です"); return; }
  pages.push(name);
  currentPage=name;
  loadPage();
  renderPageNav();
});

// ====== 戻る ======
backMainBtn.addEventListener("click",()=>location.href="index.html");

// ====== 保存 ======
saveBtn.addEventListener("click",()=>{
  saveCurrentPage();
  alert("保存しました！");
});

function saveCurrentPage(){
  const data=[];
  document.querySelectorAll(".combo-row").forEach(row=>{
    const title=row.querySelector(".row-title").value;
    const moves=[...row.querySelectorAll(".image-box img")].map(img=>img.alt);
    data.push({title,moves});
  });
  localStorage.setItem(`comboData_${characterId}_${currentPage}`,JSON.stringify(data));
}

// ====== ページ読み込み ======
function loadPage(){
  comboArea.innerHTML="";
  rowCount=0;
  const data=JSON.parse(localStorage.getItem(`comboData_${characterId}_${currentPage}`)||"[]");
  data.forEach(d=>addRow(d));
}

// ====== 段追加 ======
addRowBtn.addEventListener("click",()=>addRow());

function addRow(savedData=null){
  rowCount++;
  const rowDiv=document.createElement("div");
  rowDiv.classList.add("combo-row");

  const header=document.createElement("div");
  header.classList.add("row-header");

  const titleInput=document.createElement("input");
  titleInput.type="text";
  titleInput.value=savedData?.title||`コンボ${rowCount}`;
  titleInput.classList.add("row-title");

  const deleteBtn=document.createElement("button");
  deleteBtn.textContent="×段削除";
  deleteBtn.classList.add("row-delete-btn");
  deleteBtn.addEventListener("click",()=>{ if(!confirm("この段を削除しますか？")) return; rowDiv.remove(); });

  const duplicateBtn=document.createElement("button");
  duplicateBtn.textContent="複製";
  duplicateBtn.classList.add("row-duplicate-btn");
  duplicateBtn.addEventListener("click",()=>duplicateRow(rowDiv));

  header.appendChild(titleInput);
  header.appendChild(deleteBtn);
  header.appendChild(duplicateBtn);

  const controls=document.createElement("div");
  controls.classList.add("controls");
  const select=document.createElement("select");
  const defaultOption=document.createElement("option");
  defaultOption.value="";
  defaultOption.textContent="技を選択してください";
  select.appendChild(defaultOption);
  moveList.forEach(move=>{ const o=document.createElement("option"); o.value=move; o.textContent=move; select.appendChild(o); });
  const addBtn=document.createElement("button");
  addBtn.textContent="追加";
  controls.appendChild(select);
  controls.appendChild(addBtn);

  const container=document.createElement("div");
  container.classList.add("image-container");

  addBtn.addEventListener("click",()=>{
    const move=select.value;
    if(move && imageMap[move]) addImageBox(container,move);
  });
  if(savedData?.moves) savedData.moves.forEach(m=>addImageBox(container,m));

  rowDiv.appendChild(header);
  rowDiv.appendChild(controls);
  rowDiv.appendChild(container);
  comboArea.appendChild(rowDiv);

  addRowDragAndDrop(rowDiv);

  return rowDiv; // ★ 作った行を返す
}

// ====== 複製 ======
function duplicateRow(row){
  const title=row.querySelector(".row-title").value+"_コピー";
  const moves=[...row.querySelectorAll(".image-box img")].map(img=>img.alt);
  const newRow = addRow({title,moves});
  row.after(newRow); // ★ 複製元のすぐ下に配置
}

// ====== 画像ボックス追加 ======
function addImageBox(container,move){
  const box=document.createElement("div");
  box.classList.add("image-box");
  box.draggable=true;

  const img=document.createElement("img");
  img.src=imageMap[move];
  img.alt=move;

  const delBtn=document.createElement("button");
  delBtn.textContent="×";
  delBtn.classList.add("delete-btn");
  delBtn.addEventListener("click",()=>box.remove());

  box.appendChild(img);
  box.appendChild(delBtn);
  container.appendChild(box);
  addDragAndDrop(box,container);
}

// ====== 画像横ドラッグ ======
function addDragAndDrop(element,container){
  element.addEventListener("dragstart",(e)=>{
    e.dataTransfer.setData("text/plain","");
    element.classList.add("dragging");
    const guide = document.createElement("div");
    guide.classList.add("drag-guide");
    container.appendChild(guide);
    container.dragGuide = guide;
  });

  element.addEventListener("dragend",()=>{
    element.classList.remove("dragging");
    if(container.dragGuide) container.dragGuide.style.display="none";
  });

  container.addEventListener("dragover",(e)=>{
    e.preventDefault();
    const dragging = container.querySelector(".dragging");
    const after = getDragAfterElementHorizontal(container,e.clientX);
    const guide = container.dragGuide;
    if(after==null){
      container.appendChild(dragging);
      if(guide) guide.style.display="none";
    } else {
      container.insertBefore(dragging, after);
      if(guide){ guide.style.display = "block"; guide.style.left = after.offsetLeft + "px"; guide.style.height = container.offsetHeight + "px"; }
    }
  });
}

function getDragAfterElementHorizontal(container, x){
  const elements = [...container.querySelectorAll(".image-box:not(.dragging)")];
  return elements.find(el=>{
    const rect = el.getBoundingClientRect();
    return x < rect.left + rect.width/2;
  });
}

// ====== 段上下ドラッグ ======
function addRowDragAndDrop(row){
  row.draggable = true;

  row.addEventListener("dragstart", (e)=>{
    e.dataTransfer.setData("text/plain","");
    row.classList.add("row-dragging");
    const guide = document.createElement("div");
    guide.classList.add("row-drag-guide");
    comboArea.appendChild(guide);
    comboArea.rowDragGuide = guide;
  });

  row.addEventListener("dragend", ()=>{
    row.classList.remove("row-dragging");
    if(comboArea.rowDragGuide) comboArea.rowDragGuide.style.display="none";
  });

  comboArea.addEventListener("dragover",(e)=>{
    e.preventDefault();
    const dragging = comboArea.querySelector(".row-dragging");
    const after = getDragAfterRow(comboArea, e.clientY);
    const guide = comboArea.rowDragGuide;

    if(dragging && after){
      comboArea.insertBefore(dragging, after);
      if(guide){ guide.style.display = "block"; guide.style.top = after.offsetTop + "px"; }
    } else if(dragging){
      comboArea.appendChild(dragging);
      if(guide) guide.style.display="none";
    }
  });
}

function getDragAfterRow(container, y){
  const rows = [...container.querySelectorAll(".combo-row:not(.row-dragging)")];
  return rows.find(row=>{
    const rect = row.getBoundingClientRect();
    return y < rect.top + rect.height/2;
  });
}

// ====== 初回ロード ======
loadPage();
</script>
</body>
</html>
