<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãƒ–ãƒ©ãƒ³ã‚« ã‚³ãƒ³ãƒœç®¡ç†</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; }
#page-nav { margin-bottom: 20px; }
#page-nav button { margin-right: 10px; padding: 5px 10px; }
.combo-row { margin-bottom: 25px; padding: 10px; border: 2px solid #666; border-radius: 8px; background: #f0f0f0; position: relative; }
.row-header { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 8px; }
.row-title { font-weight: bold; font-size: 16px; padding: 5px; flex: 1; }
.row-delete-btn, .row-duplicate-btn { background: red; color: white; border: none; border-radius: 5px; padding: 4px 8px; cursor: pointer; flex-shrink: 0; }
.row-duplicate-btn { background: orange; }
.controls { margin: 10px 0; }
.image-container { display: flex; gap: 10px; flex-wrap: wrap; position: relative; }
.image-box { position: relative; width: 120px; height: 120px; border: 2px solid #ccc; border-radius: 8px; overflow: hidden; background: #f9f9f9; cursor: grab; }
.image-box img { width: 120px; height: 120px; object-fit: contain; }
.delete-btn { position: absolute; top: 5px; right: 5px; background: gray; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; }
.drag-guide { width: 4px; background: #007bff; position: absolute; top:0; height:100%; z-index:1000; display:none; }
.row-drag-guide { height: 4px; background: #ff6600; width: 100%; position: absolute; left:0; z-index:1000; display:none; }
</style>
</head>
<body>
<h2>ãƒ–ãƒ©ãƒ³ã‚« ã‚³ãƒ³ãƒœç®¡ç†</h2>
<div id="page-nav"></div>
<button id="add-page-btn">ï¼‹ ãƒšãƒ¼ã‚¸è¿½åŠ </button>
<button id="save-btn">ğŸ’¾ ä¿å­˜</button>
<button id="back-main">ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</button>
<button id="add-row-btn">ï¼‹ æ®µã‚’è¿½åŠ </button>
<div id="combo-area"></div>

<script>
// ====== å…±é€šå¤‰æ•° ======
const comboArea = document.getElementById("combo-area");
const pageNav = document.getElementById("page-nav");
const addPageBtn = document.getElementById("add-page-btn");
const saveBtn = document.getElementById("save-btn");
const backMainBtn = document.getElementById("back-main");
const addRowBtn = document.getElementById("add-row-btn");

const characterId = location.pathname.split("/").pop().replace(".html","");

let pages = ["default","recommended"];
let currentPage = pages[0];
let rowCount = 0;

// ====== ãƒ–ãƒ©ãƒ³ã‚«å°‚ç”¨æŠ€ãƒªã‚¹ãƒˆ ======
const moveList = [
  "5å¼±P","2å¼±P","5å¼±K","2å¼±K",
      "5ä¸­P","6ä¸­P","2ä¸­P","5ä¸­K","4ä¸­K","6ä¸­K","2ä¸­K",
      "5å¼·P","6å¼·P","2å¼·P","3å¼·P","5å¼·K","2å¼·K",
      "ã‚¨ãƒ¬ã‚¯ãƒˆãƒªãƒƒã‚¯ã‚µãƒ³ãƒ€ãƒ¼","ODã‚¨ãƒ¬ã‚¯ãƒˆãƒªãƒƒã‚¯ã‚µãƒ³ãƒ€ãƒ¼","ãƒãƒƒã‚¯ã‚¹ãƒ†ãƒƒãƒ—ãƒ­ãƒ¼ãƒªãƒ³ã‚°","ODãƒãƒƒã‚¯ã‚¹ãƒ†ãƒƒãƒ—ãƒ­ãƒ¼ãƒªãƒ³ã‚°",
      "å¼±ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¢ã‚¿ãƒƒã‚¯","ä¸­ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¢ã‚¿ãƒƒã‚¯","å¼·ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¢ã‚¿ãƒƒã‚¯","ODãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¢ã‚¿ãƒƒã‚¯",
      "å¼±ã‚¨ãƒªã‚¢ãƒ«ãƒ­ãƒ¼ãƒªãƒ³ã‚°","ä¸­ã‚¨ãƒªã‚¢ãƒ«ãƒ­ãƒ¼ãƒªãƒ³ã‚°","å¼·ã‚¨ãƒªã‚¢ãƒ«ãƒ­ãƒ¼ãƒªãƒ³ã‚°","ODã‚¨ãƒªã‚¢ãƒ«ãƒ­ãƒ¼ãƒªãƒ³ã‚°",
      "å¼±ãƒãƒ¼ãƒã‚«ãƒ«ãƒ­ãƒ¼ãƒªãƒ³ã‚°","ä¸­ãƒãƒ¼ãƒã‚«ãƒ«ãƒ­ãƒ¼ãƒªãƒ³ã‚°","å¼·ãƒãƒ¼ãƒã‚«ãƒ«ãƒ­ãƒ¼ãƒªãƒ³ã‚°","ODãƒãƒ¼ãƒã‚«ãƒ«ãƒ­ãƒ¼ãƒªãƒ³ã‚°",
      "ãƒ•ã‚£ã‚¢ãƒ¼ãƒ€ã‚¦ãƒ³","ãƒ¯ã‚¤ãƒ«ãƒ‰ãƒªãƒ•ãƒˆ","ãƒ¬ã‚¤ãƒ‰ã‚¸ãƒ£ãƒ³ãƒ—",
      "1P","2P","3P","4P","6P","7P","8P","9P",
      "ãƒ–ãƒ©ãƒ³ã‚«ã¡ã‚ƒã‚“çˆ†å¼¾","ãƒ–ãƒ©ãƒ³ã‚«ã¡ã‚ƒã‚“HIT","ã‚µãƒ—ãƒ©ã‚¤ã‚ºãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰","ã‚µãƒ—ãƒ©ã‚¤ã‚ºãƒãƒƒã‚¯",
      "SA1","SA2","SA3",
      "ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒƒã‚·ãƒ¥","ãƒ‰ãƒ©ã‚¤ãƒ–ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ","æŠ•ã’","ãƒ‡ã‚£ãƒ¬ã‚¤","å‰ã‚¹ãƒ†ãƒƒãƒ—",
      "Jå¼±P","Jä¸­P","Jå¼·P","Jå¼±K","Jä¸­K","Jå¼·K","å‚ç›´Jå¼·P"
];

const imageMap = {};
moveList.forEach(move => { imageMap[move] = `images/${characterId}/${move}.png`; });

// ====== ãƒšãƒ¼ã‚¸åˆ‡æ›¿ ======
function renderPageNav(){
  pageNav.innerHTML="";
  pages.forEach(p=>{
    const btn=document.createElement("button");
    btn.textContent=p;
    btn.dataset.page=p;

    if(p === "recommended"){
      btn.addEventListener("click",()=>{ location.href = "blanka_recommended.html"; });
    } else {
      btn.addEventListener("click",()=>{
        saveCurrentPage();
        currentPage=p;
        loadPage();
        renderPageNav();
      });
    }

    if(p===currentPage) btn.style.fontWeight="bold";

    if(!["default","recommended"].includes(p)){
      const delBtn=document.createElement("button");
      delBtn.textContent="Ã—";
      delBtn.addEventListener("click",()=>{
        if(!confirm(`ãƒšãƒ¼ã‚¸ã€Œ${p}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        pages = pages.filter(pageName => pageName!==p);
        localStorage.removeItem(`comboData_${characterId}_${p}`);
        if(currentPage===p) currentPage="default";
        loadPage();
        renderPageNav();
      });
      pageNav.appendChild(delBtn);
    }

    pageNav.appendChild(btn);
  });
}
renderPageNav();

// ====== ãƒšãƒ¼ã‚¸è¿½åŠ  ======
addPageBtn.addEventListener("click",()=>{
  let name=prompt("æ–°ã—ã„ãƒšãƒ¼ã‚¸åã‚’å…¥åŠ›");
  if(!name) return;
  if(pages.includes(name)){ alert("ã™ã§ã«å­˜åœ¨ã™ã‚‹ãƒšãƒ¼ã‚¸åã§ã™"); return; }
  pages.push(name);
  currentPage=name;
  loadPage();
  renderPageNav();
});

// ====== æˆ»ã‚‹ ======
backMainBtn.addEventListener("click",()=>location.href="index.html");

// ====== ä¿å­˜ ======
saveBtn.addEventListener("click",()=>{
  saveCurrentPage();
  alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
});

function saveCurrentPage(){
  const data=[];
  document.querySelectorAll(".combo-row").forEach(row=>{
    const title=row.querySelector(".row-title").value;
    const moves=[...row.querySelectorAll(".image-box img")].map(img=>img.alt);
    data.push({title,moves});
  });
  localStorage.setItem(`comboData_${characterId}_${currentPage}`,JSON.stringify(data));
}

// ====== ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ ======
function loadPage(){
  comboArea.innerHTML="";
  rowCount=0;
  const data=JSON.parse(localStorage.getItem(`comboData_${characterId}_${currentPage}`)||"[]");
  data.forEach(d=>addRow(d));
}

// ====== æ®µè¿½åŠ  ======
addRowBtn.addEventListener("click",()=>addRow());

function addRow(savedData=null){
  rowCount++;
  const rowDiv=document.createElement("div");
  rowDiv.classList.add("combo-row");

  const header=document.createElement("div");
  header.classList.add("row-header");

  const titleInput=document.createElement("input");
  titleInput.type="text";
  titleInput.value=savedData?.title||`ã‚³ãƒ³ãƒœ${rowCount}`;
  titleInput.classList.add("row-title");

  const deleteBtn=document.createElement("button");
  deleteBtn.textContent="Ã—æ®µå‰Šé™¤";
  deleteBtn.classList.add("row-delete-btn");
  deleteBtn.addEventListener("click",()=>{ if(!confirm("ã“ã®æ®µã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return; rowDiv.remove(); });

  const duplicateBtn=document.createElement("button");
  duplicateBtn.textContent="è¤‡è£½";
  duplicateBtn.classList.add("row-duplicate-btn");
  duplicateBtn.addEventListener("click",()=>duplicateRow(rowDiv));

  header.appendChild(titleInput);
  header.appendChild(deleteBtn);
  header.appendChild(duplicateBtn);

  const controls=document.createElement("div");
  controls.classList.add("controls");
  const select=document.createElement("select");
  const defaultOption=document.createElement("option");
  defaultOption.value="";
  defaultOption.textContent="æŠ€ã‚’é¸æŠã—ã¦ãã ã•ã„";
  select.appendChild(defaultOption);
  moveList.forEach(move=>{ const o=document.createElement("option"); o.value=move; o.textContent=move; select.appendChild(o); });
  const addBtn=document.createElement("button");
  addBtn.textContent="è¿½åŠ ";
  controls.appendChild(select);
  controls.appendChild(addBtn);

  const container=document.createElement("div");
  container.classList.add("image-container");

  addBtn.addEventListener("click",()=>{
    const move=select.value;
    if(move && imageMap[move]) addImageBox(container,move);
  });
  if(savedData?.moves) savedData.moves.forEach(m=>addImageBox(container,m));

  rowDiv.appendChild(header);
  rowDiv.appendChild(controls);
  rowDiv.appendChild(container);
  comboArea.appendChild(rowDiv);

  addRowDragAndDrop(rowDiv);

  return rowDiv; // â˜… ä½œã£ãŸè¡Œã‚’è¿”ã™
}

// ====== è¤‡è£½ ======
function duplicateRow(row){
  const title=row.querySelector(".row-title").value+"_ã‚³ãƒ”ãƒ¼";
  const moves=[...row.querySelectorAll(".image-box img")].map(img=>img.alt);
  const newRow = addRow({title,moves});
  row.after(newRow); // â˜… è¤‡è£½å…ƒã®ã™ãä¸‹ã«é…ç½®
}

// ====== ç”»åƒãƒœãƒƒã‚¯ã‚¹è¿½åŠ  ======
function addImageBox(container,move){
  const box=document.createElement("div");
  box.classList.add("image-box");
  box.draggable=true;

  const img=document.createElement("img");
  img.src=imageMap[move];
  img.alt=move;

  const delBtn=document.createElement("button");
  delBtn.textContent="Ã—";
  delBtn.classList.add("delete-btn");
  delBtn.addEventListener("click",()=>box.remove());

  box.appendChild(img);
  box.appendChild(delBtn);
  container.appendChild(box);
  addDragAndDrop(box,container);
}

// ====== ç”»åƒæ¨ªãƒ‰ãƒ©ãƒƒã‚° ======
function addDragAndDrop(element,container){
  element.addEventListener("dragstart",(e)=>{
    e.dataTransfer.setData("text/plain","");
    element.classList.add("dragging");
    const guide = document.createElement("div");
    guide.classList.add("drag-guide");
    container.appendChild(guide);
    container.dragGuide = guide;
  });

  element.addEventListener("dragend",()=>{
    element.classList.remove("dragging");
    if(container.dragGuide) container.dragGuide.style.display="none";
  });

  container.addEventListener("dragover",(e)=>{
    e.preventDefault();
    const dragging = container.querySelector(".dragging");
    const after = getDragAfterElementHorizontal(container,e.clientX);
    const guide = container.dragGuide;
    if(after==null){
      container.appendChild(dragging);
      if(guide) guide.style.display="none";
    } else {
      container.insertBefore(dragging, after);
      if(guide){ guide.style.display = "block"; guide.style.left = after.offsetLeft + "px"; guide.style.height = container.offsetHeight + "px"; }
    }
  });
}

function getDragAfterElementHorizontal(container, x){
  const elements = [...container.querySelectorAll(".image-box:not(.dragging)")];
  return elements.find(el=>{
    const rect = el.getBoundingClientRect();
    return x < rect.left + rect.width/2;
  });
}

// ====== æ®µä¸Šä¸‹ãƒ‰ãƒ©ãƒƒã‚° ======
function addRowDragAndDrop(row){
  row.draggable = true;

  row.addEventListener("dragstart", (e)=>{
    e.dataTransfer.setData("text/plain","");
    row.classList.add("row-dragging");
    const guide = document.createElement("div");
    guide.classList.add("row-drag-guide");
    comboArea.appendChild(guide);
    comboArea.rowDragGuide = guide;
  });

  row.addEventListener("dragend", ()=>{
    row.classList.remove("row-dragging");
    if(comboArea.rowDragGuide) comboArea.rowDragGuide.style.display="none";
  });

  comboArea.addEventListener("dragover",(e)=>{
    e.preventDefault();
    const dragging = comboArea.querySelector(".row-dragging");
    const after = getDragAfterRow(comboArea, e.clientY);
    const guide = comboArea.rowDragGuide;

    if(dragging && after){
      comboArea.insertBefore(dragging, after);
      if(guide){ guide.style.display = "block"; guide.style.top = after.offsetTop + "px"; }
    } else if(dragging){
      comboArea.appendChild(dragging);
      if(guide) guide.style.display="none";
    }
  });
}

function getDragAfterRow(container, y){
  const rows = [...container.querySelectorAll(".combo-row:not(.row-dragging)")];
  return rows.find(row=>{
    const rect = row.getBoundingClientRect();
    return y < rect.top + rect.height/2;
  });
}

// ====== åˆå›ãƒ­ãƒ¼ãƒ‰ ======
loadPage();
</script>
</body>
</html>
