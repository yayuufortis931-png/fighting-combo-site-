<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>サガット コンボ管理</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; }
#page-nav { margin-bottom: 20px; }
#page-nav button { margin-right: 10px; padding: 5px 10px; }
.combo-row { margin-bottom: 25px; padding: 10px; border: 2px solid #666; border-radius: 8px; background: #f0f0f0; position: relative; }
.row-header { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 8px; }
.row-title { font-weight: bold; font-size: 16px; padding: 5px; flex: 1; }
.row-delete-btn, .row-duplicate-btn { background: red; color: white; border: none; border-radius: 5px; padding: 4px 8px; cursor: pointer; flex-shrink: 0; }
.row-duplicate-btn { background: orange; }
.controls { margin: 10px 0; }
.image-container { display: flex; gap: 10px; flex-wrap: wrap; }
.image-box { position: relative; width: 120px; height: 120px; border: 2px solid #ccc; border-radius: 8px; overflow: hidden; background: #f9f9f9; cursor: grab; }
.image-box img { width: 100%; height: 100%; object-fit: contain; }
.delete-btn { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; }
.drag-over { border: 2px dashed #007bff; }
</style>
</head>
<body>
<h2>サガット コンボ管理</h2>
<div id="page-nav"></div>
<button id="add-page-btn">＋ ページ追加</button>
<button id="save-btn">💾 保存</button>
<button id="back-main">メインページに戻る</button>
<button id="add-row-btn">＋ 段を追加</button>
<div id="combo-area"></div>

<script>
const comboArea = document.getElementById("combo-area");
const pageNav = document.getElementById("page-nav");
const addPageBtn = document.getElementById("add-page-btn");
const saveBtn = document.getElementById("save-btn");
const backMainBtn = document.getElementById("back-main");
const addRowBtn = document.getElementById("add-row-btn");

let pages = ["default","recommended"]; // 初期2ページ
let currentPage = pages[0];
let rowCount = 0;

const moveList = [
      "5弱P","2弱P","5弱K","6弱K","2弱K",
      "5中P","6中P","2中P","5中K","2中K",
      "5強P","4強P","2強P","5強K","5強K(1段目)","6強K","2強K",
      "2中P2強P","2中P2強K","5中K5強K","5強P5強K",
      "弱タイガーショット","中タイガーショット","強タイガーショット","ODタイガーショット",
      "弱タイガーアパカ","中タイガーアパカ","強タイガーアパカ","溜めアパカ","ODタイガーアパカ",
      "弱タイガーニー","中タイガーニー","強タイガーニー","ODタイガーニー",
      "弱タイガーネクサス","中タイガーネクサス","強タイガーネクサス","ODタイガーネクサス",
      "弱派生","中派生","強派生",
      "SA1","SA2","SA3",
      "ドライブラッシュ","ドライブインパクト","投げ","ジャンプ","前ステップ",
      "J弱P","J中P","J強P","J弱K","J中K","J強K"
    ];

const imageMap = {};
moveList.forEach(move=>{ imageMap[move]=`images/sagat/${move}.png`; });

// --- ページ切替
function renderPageNav(){
  pageNav.innerHTML="";
  pages.forEach(p=>{
    const btn = document.createElement("button");
    btn.textContent=p;
    btn.dataset.page=p;
    if(p===currentPage) btn.style.fontWeight="bold";
    btn.addEventListener("click",()=>{
      saveCurrentPage();
      currentPage = p;
      loadPage();
      renderPageNav();
    });
    pageNav.appendChild(btn);
    // 削除ボタン（初期ページ以外）
    if(!["default","recommended"].includes(p)){
      const delBtn = document.createElement("button");
      delBtn.textContent="×";
      delBtn.addEventListener("click",()=>{
        pages = pages.filter(pageName=>pageName!==p);
        localStorage.removeItem(`comboData_${p}`);
        if(currentPage===p) currentPage="default";
        loadPage();
        renderPageNav();
      });
      pageNav.appendChild(delBtn);
    }
  });
}
renderPageNav();

// --- ページ追加
addPageBtn.addEventListener("click",()=>{
  let name = prompt("新しいページ名を入力");
  if(!name) return;
  if(pages.includes(name)){ alert("すでに存在するページ名です"); return; }
  pages.push(name);
  currentPage = name;
  loadPage();
  renderPageNav();
});

// --- 戻る
backMainBtn.addEventListener("click",()=>location.href="index.html");

// --- 保存
saveBtn.addEventListener("click",()=>{ saveCurrentPage(); alert("保存しました！"); });

function saveCurrentPage(){
  const data=[];
  document.querySelectorAll(".combo-row").forEach(row=>{
    const title=row.querySelector(".row-title").value;
    const moves=[...row.querySelectorAll(".image-box img")].map(img=>img.alt);
    data.push({title,moves});
  });
  localStorage.setItem(`comboData_${currentPage}`,JSON.stringify(data));
}

// --- ページ読み込み
function loadPage(){
  comboArea.innerHTML="";
  rowCount=0;
  const data=JSON.parse(localStorage.getItem(`comboData_${currentPage}`)||"[]");
  data.forEach(d=>addRow(d));
}

// --- 段追加
addRowBtn.addEventListener("click",()=>addRow());

function addRow(savedData=null){
  rowCount++;
  const rowDiv=document.createElement("div");
  rowDiv.classList.add("combo-row");

  const header=document.createElement("div"); header.classList.add("row-header");

  const titleInput=document.createElement("input"); titleInput.type="text";
  titleInput.value=savedData?.title||`コンボ${rowCount}`; titleInput.classList.add("row-title");

  const deleteBtn=document.createElement("button");
  deleteBtn.textContent="×段削除"; deleteBtn.classList.add("row-delete-btn");
  deleteBtn.addEventListener("click",()=>rowDiv.remove());

  const duplicateBtn=document.createElement("button");
  duplicateBtn.textContent="複製"; duplicateBtn.classList.add("row-duplicate-btn");
  duplicateBtn.addEventListener("click",()=>duplicateRow(rowDiv));

  header.appendChild(titleInput); header.appendChild(deleteBtn); header.appendChild(duplicateBtn);

  const controls=document.createElement("div"); controls.classList.add("controls");
  const select=document.createElement("select");
  const defaultOption=document.createElement("option"); defaultOption.value=""; defaultOption.textContent="技を選択してください"; select.appendChild(defaultOption);
  moveList.forEach(move=>{ const o=document.createElement("option"); o.value=move; o.textContent=move; select.appendChild(o); });
  const addBtn=document.createElement("button"); addBtn.textContent="追加"; controls.appendChild(select); controls.appendChild(addBtn);

  const container=document.createElement("div"); container.classList.add("image-container");

  addBtn.addEventListener("click",()=>{ const move=select.value; if(move && imageMap[move]) addImageBox(container,move); });
  if(savedData?.moves) savedData.moves.forEach(m=>addImageBox(container,m));

  rowDiv.appendChild(header); rowDiv.appendChild(controls); rowDiv.appendChild(container);
  comboArea.appendChild(rowDiv);
}

function duplicateRow(row){
  const title=row.querySelector(".row-title").value+"_コピー";
  const moves=[...row.querySelectorAll(".image-box img")].map(img=>img.alt);
  addRow({title,moves});
}

function addImageBox(container,move){
  const box=document.createElement("div"); box.classList.add("image-box"); box.draggable=true;
  const img=document.createElement("img"); img.src=imageMap[move]; img.alt=move;
  const delBtn=document.createElement("button"); delBtn.textContent="×"; delBtn.classList.add("delete-btn"); delBtn.addEventListener("click",()=>box.remove());
  box.appendChild(img); box.appendChild(delBtn); container.appendChild(box); addDragAndDrop(box,container);
}

// --- ドラッグ並べ替え
function addDragAndDrop(element,container){
  element.addEventListener("dragstart",(e)=>{ e.dataTransfer.setData("text/plain",""); element.classList.add("dragging"); });
  element.addEventListener("dragend",()=>{ element.classList.remove("dragging"); });
  container.addEventListener("dragover",(e)=>{ e.preventDefault();
    const dragging=container.querySelector(".dragging");
    const after=getDragAfterElement(container,e.clientY);
    if(after==null) container.appendChild(dragging); else container.insertBefore(dragging,after);
  });
}
function getDragAfterElement(container,y){
  const elements=[...container.querySelectorAll(".image-box:not(.dragging)")];
  return elements.find(el=>{const rect=el.getBoundingClientRect(); return y<rect.top+rect.height/2;});
}

// --- 初回ロード
loadPage();
</script>
</body>
</html>
