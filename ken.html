<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>„Ç±„É≥ „Ç≥„É≥„ÉúÁÆ°ÁêÜ</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
#page-nav { margin-bottom: 20px; }
#page-nav button, #add-page-btn, #save-btn, #back-main, #add-row-btn {
  margin-right: 8px; padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer;
  background: #666; color: white; transition: background 0.2s;
}
#page-nav button:hover, #add-page-btn:hover, #save-btn:hover, #back-main:hover, #add-row-btn:hover { background: #444; }
#page-nav button[style*="bold"] { background: #333; }
.combo-row {
  margin-bottom: 20px; padding: 12px; border: 2px solid #666; border-radius: 8px;
  background: #fff; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: grab;
}
.combo-row.placeholder {
  border: 2px dashed #2196f3; background: #e0f0ff; min-height: 80px;
}
.row-header { display: flex; justify-content: flex-start; align-items: center; gap: 6px; flex-wrap: wrap; margin-bottom: 10px; }
.row-title { font-weight: bold; font-size: 15px; padding: 4px; flex: 1; }
.action-btn { border: none; border-radius: 5px; padding: 4px 8px; cursor: pointer; color: white; font-size: 13px; }
.delete { background: #e53935; }
.duplicate { background: #ff9800; }
.copy { background: #43a047; }
.controls { margin: 10px 0; display: flex; gap: 8px; flex-wrap: wrap; }
.image-container { display: flex; gap: 10px; flex-wrap: wrap; position: relative; }
.image-box { position: relative; width: 100px; height: 100px; border: 1px solid #ccc; border-radius: 6px; overflow: hidden; background: #fafafa; }
.image-box img { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }
.delete-btn { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; z-index: 10; }
.combo-output { display: flex; align-items: center; gap: 6px; margin-top: 10px; background: #f9f9f9; padding: 6px 8px; border-radius: 5px; border: 1px solid #ccc; font-family: monospace; font-size: 14px; }
.combo-text { flex: 1; text-align: left; }

/* ====== „Çπ„Éû„ÉõÁî®„Éú„Çø„É≥Êã°Â§ß ====== */
@media (max-width: 768px) {
  #page-nav button,
  #add-page-btn,
  #save-btn,
  #back-main,
  #add-row-btn,
  .action-btn {
    padding: 12px 20px;
    font-size: 18px;
  }

  .row-title {
    font-size: 18px;
    padding: 8px;
  }

  .image-box {
    width: 120px;
    height: 120px;
  }

  .combo-output {
    font-size: 16px;
    padding: 10px 12px;
  }
}
</style>
</head>
<body>
<h2>„Ç±„É≥ „Ç≥„É≥„ÉúÁÆ°ÁêÜ</h2>
<div id="page-nav"></div>
<button id="add-page-btn">Ôºã „Éö„Éº„Ç∏ËøΩÂä†</button>
<button id="save-btn">üíæ ‰øùÂ≠ò</button>
<button id="back-main">„É°„Ç§„É≥„Éö„Éº„Ç∏„Å´Êàª„Çã</button>
<button id="add-row-btn">Ôºã ÊÆµ„ÇíËøΩÂä†</button>
<div id="combo-area"></div>

<script>
// ====== ÂÖ±ÈÄöÂ§âÊï∞ ======
const comboArea = document.getElementById("combo-area");
const pageNav = document.getElementById("page-nav");
const addPageBtn = document.getElementById("add-page-btn");
const saveBtn = document.getElementById("save-btn");
const backMainBtn = document.getElementById("back-main");
const addRowBtn = document.getElementById("add-row-btn");

let pages = ["default","recommended"];
let currentPage = pages[0];
let rowCount = 0;

// ====== „Ç±„É≥ÊäÄ„É™„Çπ„Éà ======
const moveList = [
 "5Âº±P","2Âº±P","5Âº±K","2Âº±K",
      "5‰∏≠P","2‰∏≠P","5‰∏≠K","2‰∏≠K",
      "5Âº∑P","2Âº∑P","5Âº∑K","2Âº∑K",
      "5‰∏≠PÔºû5Âº∑P","5‰∏≠KÔºû5‰∏≠K","5‰∏≠KÔºû5‰∏≠KÔºû5Âº∑K",
      "ÊÄ•ÂÅúÊ≠¢","Á¥´Èõª„Ç´„Ç´„ÉàËêΩ„Å®„Åó","Ë∏è„ÅøËæº„ÅøÂâçËπ¥„Çä",
      "Âº±Ê≥¢ÂãïÊã≥","‰∏≠Ê≥¢ÂãïÊã≥","Âº∑Ê≥¢ÂãïÊã≥","ODÊ≥¢ÂãïÊã≥",
      "Âº±ÊòáÈæçÊã≥","‰∏≠ÊòáÈæçÊã≥","Âº∑ÊòáÈæçÊã≥","ODÊòáÈæçÊã≥","„ÄêÂ•ÆËøÖ„ÄëÊòáÈæçÊã≥",
      "Âº±Á´úÂ∑ªÊóãÈ¢®ËÑö","‰∏≠Á´úÂ∑ªÊóãÈ¢®ËÑö","Âº∑Á´úÂ∑ªÊóãÈ¢®ËÑö","ODÁ´úÂ∑ªÊóãÈ¢®ËÑö","„ÄêÂ•ÆËøÖ„ÄëÁ´úÂ∑ªÊóãÈ¢®ËÑö",
      "Âº±ÈæçÂ∞æËÑö","‰∏≠ÈæçÂ∞æËÑö","Âº∑ÈæçÂ∞æËÑö","ODÈæçÂ∞æËÑö","„ÄêÂ•ÆËøÖ„ÄëÈæçÂ∞æËÑö",
      "Âº±ËøÖÈõ∑ËÑö","‰∏≠ËøÖÈõ∑ËÑö","Âº∑ËøÖÈõ∑ËÑö","ODËøÖÈõ∑ËÑö",
      "Âº±Ê¥æÁîü","‰∏≠Ê¥æÁîü","Âº∑Ê¥æÁîü","ODÂº±Ê¥æÁîü","OD‰∏≠Ê¥æÁîü","ODÂº∑Ê¥æÁîü","ODÂº±Ê¥æÁîü(2ÊÆµÁõÆ)","‰∏≠Ê¥æÁîü(2ÊÆµÁõÆ)","Âº∑Ê¥æÁîü(2ÊÆµÁõÆ)",
      "SA1","SA2","SA3",
      "„Éâ„É©„Ç§„Éñ„É©„ÉÉ„Ç∑„É•","cDR","„Éâ„É©„Ç§„Éñ„Ç§„É≥„Éë„ÇØ„Éà","Êäï„Åí","„Ç∏„É£„É≥„Éó","Ââç„Çπ„ÉÜ„ÉÉ„Éó","„Éá„Ç£„É¨„Ç§",
      "JÂº±P","J‰∏≠P","JÂº∑P","JÂº±K","J‰∏≠K","JÂº∑K","ÂûÇÁõ¥JÂº∑K","Á©∫‰∏≠Á´úÂ∑ªÊóãÈ¢®ËÑö","ODÁ©∫‰∏≠Á´úÂ∑ªÊóãÈ¢®ËÑö","„Åì„Åì„Åæ„Åß1„Ç≥„É≥„Éú"
  ]; 

const imageMap = {}; moveList.forEach(m=>imageMap[m]=`images/ken/${m}.png`);

// ====== „Éö„Éº„Ç∏ÂàáÊõø ======
function renderPageNav(){
  pageNav.innerHTML="";
  pages.forEach(p=>{
    const btn=document.createElement("button"); btn.textContent=p;
    if(p==="recommended") btn.addEventListener("click",()=>location.href="ken_recommended.html");
    else btn.addEventListener("click",()=>{ saveCurrentPage(); currentPage=p; loadPage(); renderPageNav(); });
    if(p===currentPage) btn.style.fontWeight="bold";
    pageNav.appendChild(btn);
  });
}
renderPageNav();

// ====== „Éö„Éº„Ç∏ËøΩÂä† ======
addPageBtn.addEventListener("click",()=>{
  const name=prompt("Êñ∞„Åó„ÅÑ„Éö„Éº„Ç∏Âêç„ÇíÂÖ•Âäõ"); if(!name) return;
  if(pages.includes(name)){ alert("„Åô„Åß„Å´Â≠òÂú®„Åô„Çã„Éö„Éº„Ç∏Âêç„Åß„Åô"); return; }
  pages.push(name); currentPage=name; loadPage(); renderPageNav();
});

// ====== Êàª„Çã ======
backMainBtn.addEventListener("click",()=>location.href="index.html");

// ====== ‰øùÂ≠ò ======
saveBtn.addEventListener("click",()=>{ saveCurrentPage(); alert("‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ"); });
function saveCurrentPage(){
  const data=[...document.querySelectorAll(".combo-row")].map(row=>({
      title: row.querySelector(".row-title").value,
      moves: [...row.querySelectorAll(".image-box img")].map(img=>img.alt)
  }));
  localStorage.setItem(`comboData_ken_${currentPage}`,JSON.stringify(data));
}

// ====== „Éö„Éº„Ç∏Ë™≠„ÅøËæº„Åø ======
function loadPage(){
  comboArea.innerHTML=""; rowCount=0;
  const data=JSON.parse(localStorage.getItem(`comboData_ken_${currentPage}`)||"[]");
  data.forEach(d=>addRow(d));
}
loadPage();

// ====== ÊÆµËøΩÂä† ======
addRowBtn.addEventListener("click",()=>addRow());
function addRow(savedData=null){
  rowCount++;
  const row=document.createElement("div"); row.className="combo-row"; row.draggable=true;

  // header
  const header=document.createElement("div"); header.className="row-header";
  const title=document.createElement("input"); title.type="text"; title.value=savedData?.title||`„Ç≥„É≥„Éú${rowCount}`; title.className="row-title";
  const del=makeBtn("ÂâäÈô§","delete",()=>row.remove());
  const dup=makeBtn("Ë§áË£Ω","duplicate",()=>duplicateRow(row));
  header.append(title,del,dup);
  row.appendChild(header);

  // controls
  const controls=document.createElement("div"); controls.className="controls";
  const select=document.createElement("select");
  const def=document.createElement("option"); def.value=""; def.textContent="ÊäÄ„ÇíÈÅ∏Êäû"; select.append(def);
  moveList.forEach(m=>{ const o=document.createElement("option"); o.value=m; o.textContent=m; select.append(o); });
  const addBtn=document.createElement("button"); addBtn.textContent="ËøΩÂä†"; controls.append(select,addBtn);
  row.appendChild(controls);

  // image container
  const container=document.createElement("div"); container.className="image-container";
  row.appendChild(container);

  // combo output
  const output=document.createElement("div"); output.className="combo-output";
  const text=document.createElement("div"); text.className="combo-text"; text.textContent=savedData?.moves?.join(" > ")||"";
  const copy=makeBtn("„Ç≥„Éî„Éº","copy",()=>navigator.clipboard.writeText(text.textContent));
  output.append(text,copy);
  row.appendChild(output);

  // ÂàùÊúüÁîªÂÉè
  if(savedData?.moves) savedData.moves.forEach(m=>addImageBox(container,m,row));

  // ËøΩÂä†„Éú„Çø„É≥
  addBtn.addEventListener("click",()=>{ if(select.value) addImageBox(container,select.value,row); });

  // ÊÆµ„Éâ„É©„ÉÉ„Ç∞ÔºàPCÈôêÂÆöÔºâ
  addRowDragAndDrop(row);

  comboArea.appendChild(row);
  return row;
}

// ====== Ë§áË£Ω ======
function duplicateRow(row){
  const title=row.querySelector(".row-title").value+"_„Ç≥„Éî„Éº";
  const moves=[...row.querySelectorAll(".image-box img")].map(img=>img.alt);
  const newRow=addRow({title,moves});
  row.after(newRow);
}

// ====== Ê±éÁî®„Éú„Çø„É≥ ======
function makeBtn(label,type,fn){
  const b=document.createElement("button");
  b.textContent=label; b.className=`action-btn ${type}`; b.addEventListener("click",fn);
  return b;
}

// ====== ÁîªÂÉèËøΩÂä† ======
function addImageBox(container,move,row){
  const box=document.createElement("div"); box.className="image-box";
  const img=document.createElement("img"); img.src=imageMap[move]; img.alt=move;
  const del=document.createElement("button"); del.textContent="√ó"; del.className="delete-btn";

  // ÈáçË¶Å: Ë¶™„ÅÆ„Éâ„É©„ÉÉ„Ç∞ÈñãÂßã„ÇíÁÑ°ÂäπÂåñ„Åó„Å¶ÂâäÈô§„ÇØ„É™„ÉÉ„ÇØ„ÇíÈÄö„Åô
  del.addEventListener("mousedown", (e)=> { e.stopPropagation(); });

  del.addEventListener("click",()=>{ box.remove(); updateComboText(row); });
  container.appendChild(box); box.appendChild(img); box.appendChild(del);

  // PCÈôêÂÆö„Éâ„É©„ÉÉ„Ç∞
  addImageDragAndDrop(box,container,row);
  updateComboText(row);
}

// ====== ÁîªÂÉè„Éâ„É©„ÉÉ„Ç∞ÔºàPC„ÅÆ„ÅøÔºâ ======
function addImageDragAndDrop(element, container, row){
  if (/Mobi|Android/i.test(navigator.userAgent)) return; // „Çπ„Éû„Éõ„Åß„ÅØÁÑ°ÂäπÂåñ

  let ghost = null;
  let offsetX = 0, offsetY = 0;

  element.addEventListener("mousedown", e=>{
    // ÈáçË¶Å: ÂâäÈô§„Éú„Çø„É≥‰∏ä„ÅÆÊìç‰Ωú„ÅØ„Éâ„É©„ÉÉ„Ç∞„ÇíÈñãÂßã„Åó„Å™„ÅÑ
    if (e.target.closest('.delete-btn')) return;

    e.preventDefault();
    offsetX = e.offsetX;
    offsetY = e.offsetY;

    ghost = element.cloneNode(true);
    ghost.style.position = "absolute";
    ghost.style.pointerEvents = "none";
    ghost.style.opacity = "0.6";
    ghost.style.zIndex = 1000;
    ghost.style.width = element.offsetWidth + "px";
    ghost.style.height = element.offsetHeight + "px";
    document.body.appendChild(ghost);
    moveGhost(e.pageX, e.pageY);

    element.style.visibility = "hidden";

    function moveGhost(pageX, pageY){
      ghost.style.left = pageX - offsetX + "px";
      ghost.style.top = pageY - offsetY + "px";
    }

    function onMouseMove(e){
      moveGhost(e.pageX, e.pageY);
    }

    document.addEventListener("mousemove", onMouseMove);

    document.addEventListener("mouseup", function onMouseUp(e){
      document.removeEventListener("mousemove", onMouseMove);
      document.removeEventListener("mouseup", onMouseUp);

      const boxes = [...container.querySelectorAll(".image-box")].filter(b=>b!==element);
      let inserted = false;
      for(const b of boxes){
        const rect = b.getBoundingClientRect();
        if(e.clientX < rect.left + rect.width/2){
          container.insertBefore(element, b);
          inserted = true;
          break;
        }
      }
      if(!inserted) container.appendChild(element);

      element.style.visibility = "visible";
      if (ghost) ghost.remove();
      ghost = null;
      updateComboText(row);
    });
  });
}

// ====== ÊÆµ„Éâ„É©„ÉÉ„Ç∞ÔºàPC„ÅÆ„ÅøÔºâ ======
function addRowDragAndDrop(row){
  if (/Mobi|Android/i.test(navigator.userAgent)) return; // „Çπ„Éû„Éõ„Åß„ÅØÁÑ°ÂäπÂåñ

  let placeholder = null;
  row.addEventListener("dragstart", e=>{
    row.classList.add("row-dragging");
    placeholder = document.createElement("div");
    placeholder.className="combo-row placeholder";
    placeholder.style.height = row.offsetHeight + "px";
    row.parentNode.insertBefore(placeholder, row.nextSibling);
    row.style.opacity="0.4";
  });

  row.addEventListener("dragend", e=>{
    row.classList.remove("row-dragging");
    row.style.opacity="1";
    if(placeholder){
      placeholder.parentNode.replaceChild(row, placeholder);
      placeholder=null;
    }
  });

  comboArea.addEventListener("dragover", e=>{
    e.preventDefault();
    const dragging=document.querySelector(".row-dragging");
    if(!dragging || !placeholder) return;
    const after=getDragAfterRow(comboArea,e.clientY);
    if(after) comboArea.insertBefore(placeholder, after);
    else comboArea.appendChild(placeholder);
  });
}

function getDragAfterRow(container,y){
  const els=[...container.querySelectorAll(".combo-row:not(.row-dragging)")];
  if(els.length===0) return null;
  return els.find(el=>y<el.getBoundingClientRect().top + el.getBoundingClientRect().height/2);
}

// ====== „Ç≥„É≥„Éú„ÉÜ„Ç≠„Çπ„ÉàÊõ¥Êñ∞ ======
function updateComboText(row){
  const moves=[...row.querySelectorAll(".image-box img")].map(img=>img.alt);
  row.querySelector(".combo-text").textContent=moves.join(" > ");
}
</script>
</body>
</html>